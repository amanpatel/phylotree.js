{"version":3,"file":"phylotree.min.js","sources":["../src/nodes.js","../src/formats/newick.js","../src/formats/nexus.js","../src/formats/phyloxml.js","../src/formats/registry.js","../src/formats/nexml.js","../src/formats/beast.js","../src/traversal.js","../src/branches.js","../src/rooting.js","../src/render/coordinates.js","../src/render/radial.js","../src/render/cartesian.js","../src/render/helpers.js","../src/render/options.js","../src/render/nodes.js","../src/render/clades.js","../src/render/edges.js","../src/render/events.js","../src/render/menus.js","../src/render/draw.js","../src/main.js","../src/metrics/pairwise-distances.js","../src/metrics/root-to-tip.js","../src/max-parsimony.js","../src/extract-dates.js","../src/metrics/center-of-tree.js","../src/clustering/cluster-picker.js","../src/metrics/compute-midpoint.js","../src/parsimony/fitch.js","../src/clustering/phylopart.js","../src/metrics/sackins.js"],"sourcesContent":["import * as _ from \"underscore\";\n\n// These methods are part of the Phylotree object\n\nexport function graft_a_node(graft_at, new_child, new_parent, lengths) {\n\n  let nodes = this.nodes.descendants();\n\n  if (graft_at.parent) {\n    let node_index = nodes.indexOf(graft_at);\n\n    if (node_index >= 0) {\n      let parent_index = graft_at.parent.children.indexOf(graft_at);\n\n      let new_split = {\n          name: new_parent,\n          parent: graft_at.parent,\n          attribute: lengths ? lengths[2] : null,\n          original_child_order: graft_at[\"original_child_order\"]\n        },\n        new_node = {\n          name: new_child,\n          parent: new_split,\n          attribute: lengths ? lengths[1] : null,\n          original_child_order: 2\n        };\n\n      new_split[\"children\"] = [graft_at, new_node];\n      graft_at[\"parent\"].children[parent_index] = new_split;\n      graft_at.parent = new_split;\n      graft_at[\"attribute\"] = lengths ? lengths[0] : null;\n      graft_at[\"original_child_order\"] = 1;\n    }\n  }\n\n  return this;\n\n}\n\n/**\n * Delete a given node.\n *\n * @param {Node} The node to be deleted, or the index of such a node.\n * @returns The current ``phylotree``.\n */\nexport function delete_a_node(index) {\n  let nodes = this.nodes.descendants();\n\n  if (typeof index != \"number\") {\n    return this.delete_a_node(nodes.indexOf(index));\n  }\n\n  if (index > 0 && index < nodes.length) {\n    let node = nodes[index];\n\n    if (node.parent) {\n      // can only delete nodes that are not the root\n      let delete_me_idx = node.parent.children.indexOf(node);\n\n      if (delete_me_idx >= 0) {\n        nodes.splice(index, 1);\n\n        if (node.children) {\n          node.children.forEach(function(d) {\n            d[\"original_child_order\"] = node.parent.children.length;\n            node.parent.children.push(d);\n            d.parent = node.parent;\n          });\n        }\n\n        if (node.parent.children.length > 2) {\n          node.parent.children.splice(delete_me_idx, 1);\n        } else {\n          if (node.parent.parent) {\n            node.parent.parent.children[\n              node.parent.parent.children.indexOf(node.parent)\n            ] =\n              node.parent.children[1 - delete_me_idx];\n            node.parent.children[1 - delete_me_idx].parent = node.parent.parent;\n            nodes.splice(nodes.indexOf(node.parent), 1);\n          } else {\n            nodes.splice(0, 1);\n            nodes.parent = null;\n            delete nodes.data[\"attribute\"];\n            delete nodes.data[\"annotation\"];\n            delete nodes.data[\"original_child_order\"];\n            nodes.name = \"root\";\n            nodes.data.name = \"root\";\n          }\n        }\n      }\n    }\n  }\n\n  return this;\n}\n\n/**\n * Get the tips of the tree\n * @returns {Array} Nodes in the current ``phylotree``.\n */\nexport function get_tips() {\n  // get all nodes that have no nodes\n  return _.filter(this.nodes.descendants(), n => {\n    return !_.has(n, \"children\");\n  });\n}\n\n/**\n * Get the internal nodes of the tree\n * @returns {Array} Nodes in the current ``phylotree``.\n */\nexport function get_internals() {\n  // get all nodes that have no nodes\n  return _.filter(this.nodes.descendants(), n => {\n    return _.has(n, \"children\");\n  });\n}\n\n\n/**\n * Get the root node.\n *\n * @returns the current root node of the ``phylotree``.\n */\nexport function get_root_node() {\n  return this.nodes;\n}\n\n/**\n * Get an array of all nodes.\n * @returns {Array} Nodes in the current ``phylotree``.\n */\nexport function get_nodes() {\n  return this.nodes;\n}\n\n/**\n * Get a node by name.\n *\n * @param {String} name Name of the desired node.\n * @returns {Node} Desired node.\n */\nexport function get_node_by_name(name) {\n  return _.filter(this.nodes.descendants(), d => {\n    return d.data.name == name;\n  })[0];\n}\n\n/**\n * Add attributes to nodes. New attributes will be placed in the\n * ``annotations`` key of any nodes that are matched.\n *\n * @param {Object} attributes An object whose keys are the names of nodes\n * to modify, and whose values are the new attributes to add.\n */\nexport function assign_attributes(attributes) {\n  //return nodes;\n  // add annotations to each matching node\n  _.each(this.nodes, function(d) {\n    if (_.indexOf(_.keys(attributes), d.name) >= 0) {\n      d[\"annotations\"] = attributes[d.name];\n    }\n  });\n}\n\n/**\n * Determine if a given node is a leaf node.\n *\n * @param {Node} A node in a tree.\n * @returns {Bool} Whether or not the node is a leaf node.\n */\nexport function is_leafnode(node) {\n  return !_.has(node, \"children\")\n}\n\n/**\n * Update a given key name in each node.\n *\n * @param {String} old_key The old key name.\n * @param {String} new_key The new key name.\n * @returns The current ``this``.\n */\nexport function update_key_name(old_key, new_key) {\n  this.nodes.each(function(n) {\n    if (old_key in n) {\n      if (new_key) {\n        n[new_key] = n[old_key];\n      }\n      delete n[old_key];\n    }\n  });\n\n  return this;\n}\n\nexport function clear_internal_nodes(respect) {\n  if (!respect) {\n    this.nodes.each(d => {\n      if (!is_leafnode(d)) {\n        d[this.selection_attribute_name] = false;\n      }\n    });\n  }\n}\n\n\n","import * as _ from \"underscore\";\nimport { is_leafnode } from \"../nodes\";\n\n/**\n * Parses a Newick string into an equivalent JSON representation that is\n * suitable for consumption by ``hierarchy``.\n *\n * Optionally accepts bootstrap values. Currently supports Newick strings with or without branch lengths,\n * as well as tagged trees such as\n *  ``(a,(b{TAG},(c{TAG},d{ANOTHERTAG})))``\n *\n * @param {String} nwk_str - A string representing a phylogenetic tree in Newick format.\n * @param {Object} bootstrap_values.\n * @returns {Object} An object with keys ``json`` and ``error``.\n */\n\nfunction newick_parser(nwk_str, bootstrap_values, delimiter) {\n  bootstrap_values = true;\n  let left_delimiter = delimiter || '{',\n    right_delimiter = left_delimiter == '{' ? '}' : ']';\n  let clade_stack = [];\n\n  function add_new_tree_level() {\n    let new_level = {\n      name: null\n    };\n\n    let the_parent = clade_stack[clade_stack.length - 1];\n\n    if (!(\"children\" in the_parent)) {\n      the_parent[\"children\"] = [];\n    }\n\n    clade_stack.push(new_level);\n\n    the_parent[\"children\"].push(clade_stack[clade_stack.length - 1]);\n\n    clade_stack[clade_stack.length - 1][\"original_child_order\"] =\n      the_parent[\"children\"].length;\n  }\n\n  function finish_node_definition() {\n    let this_node = clade_stack.pop();\n\n    this_node[\"name\"] = current_node_name;\n\n    if (bootstrap_values && \"children\" in this_node) {\n      this_node[\"bootstrap_values\"] = current_node_name;\n    } else {\n      this_node[\"name\"] = current_node_name;\n    }\n\n    this_node[\"attribute\"] = current_node_attribute;\n    this_node[\"annotation\"] = current_node_annotation;\n\n    current_node_name = \"\";\n    current_node_attribute = \"\";\n    current_node_annotation = \"\";\n  }\n\n  function generate_error(location) {\n    return {\n      json: null,\n      error:\n        \"Unexpected '\" +\n        nwk_str[location] +\n        \"' in '\" +\n        nwk_str.substring(location - 20, location + 1) +\n        \"[ERROR HERE]\" +\n        nwk_str.substring(location + 1, location + 20) +\n        \"'\"\n    };\n  }\n\n  let automaton_state = 0;\n  let current_node_name = \"\";\n  let current_node_attribute = \"\";\n  let current_node_annotation = \"\";\n  let quote_delimiter = null;\n\n  let name_quotes = {\n    \"'\": 1,\n    '\"': 1\n  };\n\n  let tree_json = {\n    name: \"root\"\n  };\n\n  clade_stack.push(tree_json);\n\n  var space = /\\s/;\n\n  for (var char_index = 0; char_index < nwk_str.length; char_index++) {\n    try {\n      var current_char = nwk_str[char_index];\n      switch (automaton_state) {\n        case 0: {\n          // look for the first opening parenthesis\n          if (current_char == \"(\") {\n            add_new_tree_level();\n            automaton_state = 1; // expecting node name\n          }\n          break;\n        }\n        case 1: // name\n        case 3: {\n          // branch length\n          // reading name\n          if (current_char == \":\") {\n            automaton_state = 3;\n          } else if (current_char == \",\" || current_char == \")\") {\n            try {\n              finish_node_definition();\n              automaton_state = 1;\n              if (current_char == \",\") {\n                add_new_tree_level();\n              }\n            } catch (e) {\n              return generate_error(char_index);\n            }\n          } else if (current_char == \"(\") {\n            if (current_node_name.length > 0) {\n              return generate_error(char_index);\n            } else {\n              add_new_tree_level();\n            }\n          } else if (current_char in name_quotes) {\n            if (\n              automaton_state == 1 &&\n              current_node_name.length === 0 &&\n              current_node_attribute.length === 0 &&\n              current_node_annotation.length === 0\n            ) {\n              automaton_state = 2;\n              quote_delimiter = current_char;\n              continue;\n            }\n            return generate_error(char_index);\n          } else {\n            if (current_char == left_delimiter) {\n              if (current_node_annotation.length) {\n                return generate_error(char_index);\n              } else {\n                automaton_state = 4;\n              }\n            } else {\n              if (automaton_state == 3) {\n                current_node_attribute += current_char;\n              } else {\n                if (space.test(current_char)) {\n                  continue;\n                }\n                if (current_char == \";\") {\n                  // semicolon terminates tree definition\n                  char_index = nwk_str.length;\n                  break;\n                }\n                current_node_name += current_char;\n              }\n            }\n          }\n\n          break;\n        }\n        case 2: {\n          // inside a quoted expression\n          if (current_char == quote_delimiter) {\n            if (char_index < nwk_str.length - 1) {\n              if (nwk_str[char_index + 1] == quote_delimiter) {\n                char_index++;\n                current_node_name += quote_delimiter;\n                continue;\n              }\n            }\n            quote_delimiter = 0;\n            automaton_state = 1;\n            continue;\n          } else {\n            current_node_name += current_char;\n          }\n          break;\n        }\n        case 4: {\n          // inside a comment / attribute\n          if (current_char == right_delimiter) {\n            automaton_state = 3;\n          } else {\n            if (current_char == left_delimiter) {\n              return generate_error(char_index);\n            }\n            current_node_annotation += current_char;\n          }\n          break;\n        }\n      }\n    } catch (e) {\n      return generate_error(char_index);\n    }\n  }\n\n  if (clade_stack.length != 1) {\n    return generate_error(nwk_str.length - 1);\n  }\n\n  return {\n    json: tree_json,\n    error: null\n  };\n}\n\n/**\n * Return Newick string representation of a phylotree.\n *\n * @param {Function} annotator - Function to apply to each node, determining\n * what label is written (optional).\n * @returns {String} newick - Phylogenetic tree serialized as a Newick string.\n */\n\n// TODO: break this out into two seperate functions\nexport function get_newick(annotator) {\n\n  let self = this;\n\n  if (!annotator) annotator = d => d.data.name;\n\n  function escape_string(nn) {\n    let need_escape = /[\\s\\[\\]\\,\\)\\(\\:\\'\\\"]/;\n    let enquote = need_escape.test(nn);\n\t\treturn enquote ? \"'\" + nn.replace(/\\'/g, \"''\") + \"'\" : nn;\n  }\n\n  function node_display(n) {\n    if (!is_leafnode(n)) {\n      element_array.push(\"(\");\n      n.children.forEach(function(d, i) {\n        if (i) {\n          element_array.push(\",\");\n        }\n        node_display(d);\n      });\n      element_array.push(\")\");\n    }\n\n    //element_array.push(escape_string(self.node_label(n)));\n    element_array.push(annotator(n));\n\n    let bl = self.branch_length_accessor(n);\n\n    if (bl !== undefined) {\n      element_array.push(\":\" + bl);\n    }\n  }\n\n  let element_array = [];\n  annotator = annotator || \"\";\n  node_display(this.nodes);\n\n  return element_array.join(\"\")+\";\";\n\n}\n\nexport default newick_parser;\n","import * as _ from \"underscore\";\nimport {default as newick_parser} from \"./newick\";\n\nexport function parse_annotations (buf) {\n\n  let str = buf;\n  let index = str.toUpperCase().indexOf('BEGIN DATA;');\n  let data = str.slice(index);\n\n  if(data.length < 2) {\n    return '';\n  }\n\n  index = data.toUpperCase().indexOf('END;');\n  let data_str = data.slice(0, index);\n\n  // split on semicolon\n  data = _.map(data_str.split(';'), d => { return d.trim() } );\n\n  // get dimensions\n  let dimensions = _.filter(data, d => {return d.toUpperCase().startsWith('DIMENSION')}); \n  dimensions = dimensions[0].split(' ');\n  dimensions = _.object(_.map(_.rest(dimensions), d => { return d.split('=') }));\n\n  // get formats\n  let format = _.filter(data, d => {return d.toUpperCase().startsWith('FORMAT')}); \n  format = format[0].split(' ');\n  format = _.object(_.map(_.rest(format), d => { return d.split('=') }));\n  format.symbols = _.reject(format.symbols.split(\"\"), d => d=='\"');\n\n  // get character matrix\n  let matrix = _.filter(data, d => {return d.toUpperCase().startsWith('MATRIX')}); \n  matrix = matrix[0].split('\\n')\n  matrix = _.object(_.map(_.rest(matrix), d=> { return _.compact(d.split(' ')) }));\n\n  // create all possible states for matrix\n  matrix = _.mapObject(matrix, (v,k) => { \n\n    if(v == '?') {\n      return format.symbols\n    }\n    else { \n      return Array(v)\n    }\n  \n  });\n\n  return { 'dimensions' : dimensions, 'format' : format, 'matrix' : matrix }\n\n}\n\n/**\n *  Loads annotations from a nexus-formatted buffer and annotates existing tree\n *  nodes appropriately.\n *\n * @param {Object} tree - Instatiated phylotree\n * @param {String} NEXUS string\n * @returns {Object} Annotations\n */\nexport function load_annotations(tree, label, annotations) {\n\n  // if filename, then load from filesystem\n  _.each(tree.get_tips(), d => { d.data[\"test\"] = annotations.matrix[d.data.name] });\n\n  // decorate nodes with annotations\n\n}\n\nexport default function loadTree(buf) {\n\n  // if filename, then load from filesystem\n  // Parse first tree from NEXUS file and send to newick_parser\n\n  // Make all upper case\n  let str = buf;\n\n  // Get TREE block\n  let index = str.toUpperCase().indexOf('BEGIN TREES;');\n  let split = str.slice(index);\n\n  if(split.length < 2) {\n    return '';\n  }\n\n  index = split.toUpperCase().indexOf('END;');\n  let tree_str = split.slice(0, index);\n\n  // Filter lines that start with TREE\n  let trees = tree_str.split('\\n');\n  trees = _.filter(trees, d => { return d.trim().toUpperCase().startsWith('TREE') });\n\n  // Identify start of newick string\n  return newick_parser(trees[0]);\n\n}\n\n","import * as _ from \"underscore\";\n\n// Changes XML to JSON\n// Modified version from here: http://davidwalsh.name/convert-xml-json\nfunction xmlToJson(xml) {\n\n\t// Create the return object\n\tvar obj = {};\n\n\tif (xml.nodeType == 1) { // element\n\t\t// do attributes\n\t\tif (xml.attributes.length > 0) {\n\t\tobj[\"@attributes\"] = {};\n\t\t\tfor (var j = 0; j < xml.attributes.length; j++) {\n\t\t\t\tvar attribute = xml.attributes.item(j);\n\t\t\t\tobj[\"@attributes\"][attribute.nodeName] = attribute.nodeValue;\n\t\t\t}\n\t\t}\n\t} else if (xml.nodeType == 3) { // text\n\t\tobj = xml.nodeValue;\n\t}\n\n\t// do children\n\t// If just one text node inside\n\tif (xml.hasChildNodes() && xml.childNodes.length === 1 && xml.childNodes[0].nodeType === 3) {\n\t\tobj = xml.childNodes[0].nodeValue;\n\t}\n\telse if (xml.hasChildNodes()) {\n\t\tfor(var i = 0; i < xml.childNodes.length; i++) {\n\t\t\tvar item = xml.childNodes.item(i);\n\t\t\tvar nodeName = item.nodeName;\n\t\t\tif (typeof(obj[nodeName]) == \"undefined\") {\n\t\t\t\tobj[nodeName] = xmlToJson(item);\n\t\t\t} else {\n\t\t\t\tif (typeof(obj[nodeName].push) == \"undefined\") {\n\t\t\t\t\tvar old = obj[nodeName];\n\t\t\t\t\tobj[nodeName] = [];\n\t\t\t\t\tobj[nodeName].push(old);\n\t\t\t\t}\n\t\t\t\tobj[nodeName].push(xmlToJson(item));\n\t\t\t}\n\t\t}\n\t}\n\treturn obj;\n}\n\nvar phyloxml_parser = function(xml, options) {\n\n  function parse_phyloxml(node, index) {\n    if (node.clade) {\n      node.clade.forEach(parse_phyloxml);\n      node.children = node.clade;\n      delete node.clade;\n    }\n\n\t\tnode.annotation = 1;\n\t\tnode.attribute = \"0.01\";\n    if (node.branch_length) {\n\t\t\tnode.attribute = node.branch_length;\n    }\n    if (node.taxonomy) {\n      node.name = node.taxonomy.scientific_name;\n    }\n\n    node.annotation = \"\";\n\n  }\n\n  var tree_json;\n\n  xml = xmlToJson(xml);\n  tree_json = xml.phyloxml.phylogeny.clade;\n  tree_json.name = \"root\";\n  parse_phyloxml(tree_json, 0);\n\n  return {\n    json: tree_json,\n    error: null\n  };\n};\n\nexport default phyloxml_parser;\n","import { default as nexml_parser } from \"./nexml\";\nimport { default as newick_parser } from \"./newick\";\nimport { default as nexus_parser } from \"./nexus\";\nimport { default as phyloxml_parser } from \"./phyloxml\";\nimport { default as beast_parser } from \"./beast\";\n\n/* \n * A parser must have two fields, the object and\n * options\n */\nvar format_registry = {\n  nexml: nexml_parser,\n  phyloxml: phyloxml_parser,\n  nexus : nexus_parser,\n  nwk: newick_parser,\n  beast: beast_parser\n};\n\nexport default format_registry;\n","import * as _ from \"underscore\";\n//import { parseString } from \"xml2js\";\n\nvar nexml_parser = function(xml_string, options) {\n  var trees;\n  parseString(xml_string, function(error, xml) {\n    trees = xml[\"nex:nexml\"].trees[0].tree.map(function(nexml_tree) {\n      var node_list = nexml_tree.node.map(d => d.$),\n        node_hash = node_list.reduce(function(a, b) {\n          b.edges = [];\n          b.name = b.id;\n          a[b.id] = b;\n          return a;\n        }, {}),\n        roots = node_list.filter(d => d.root),\n        root_id = roots > 0 ? roots[0].id : node_list[0].id;\n      node_hash[root_id].name = \"root\";\n\n      nexml_tree.edge.map(d => d.$).forEach(function(edge) {\n        node_hash[edge.source].edges.push(edge);\n      });\n\n      function parse_nexml(node, index) {\n        if (node.edges) {\n          var targets = _.pluck(node.edges, \"target\");\n          node.children = _.values(_.pick(node_hash, targets));\n          node.children.forEach(function(child, i) {\n            child.attribute = node.edges[i].length || \"\";\n          });\n          node.children.forEach(parse_nexml);\n          node.annotation = \"\";\n        }\n      }\n\n      parse_nexml(node_hash[root_id]);\n      return node_hash[root_id];\n    });\n  });\n  return trees;\n};\n\nexport default nexml_parser;\n","import newick_parser from \"./newick\";\n\nexport default function(newick) {\n  const parsed_newick = newick_parser(newick, null, '[');\n  function parse_beast_node(node) {\n    if(node.annotation) {\n      node.beast = {};\n      const tokens = node.annotation.split(/=|,|{|}/)\n        .filter(token => token);\n      for(var i = 0; i < tokens.length; i+=2) {\n        let key = tokens[i].replace(/&|%/g, '');\n        if(/[a-df-zA-DF-Z]+/.test(tokens[i+2])) {\n          node.beast[key] = +tokens[i+1];\n        } else {\n          node.beast[key] = [+tokens[i+1], +tokens[i+2]];\n          i++;\n        }\n      }\n    }\n    node.annotation = undefined;\n    if(node.children) {\n      node.children.forEach(parse_beast_node);\n    }\n  }\n  parse_beast_node(parsed_newick.json);\n  return parsed_newick;\n}\n","import * as _ from \"lodash\";\n\nexport function postOrder(node, callback, backtrack) {\n\n  let nodes = [node],\n    next = [],\n    children,\n    i,\n    n;\n\n  while ((node = nodes.pop())) {\n    if (!(backtrack && backtrack(node))) {\n      next.push(node), (children = node.children);\n      if (children)\n        for (i = 0, n = children.length; i < n; ++i) {\n          nodes.push(children[i]);\n        }\n    }\n  }\n\n  while ((node = next.pop())) {\n    callback(node);\n  }\n\n  return node;\n\n}\n\nexport function preOrder(node, callback, backtrack) {\n  let nodes = [node],\n    children,\n    i;\n\n  while ((node = nodes.pop())) {\n    if (!(backtrack && backtrack(node))) {\n      callback(node), (children = node.children);\n      if (children)\n        for (i = children.length - 1; i >= 0; --i) {\n          nodes.push(children[i]);\n        }\n    }\n  }\n\n  return node;\n}\n\nexport default function inOrder(node, callback, backtrack) {\n  let current,\n    next = [node],\n    children,\n    i,\n    n;\n\n  do {\n    (current = next.reverse()), (next = []);\n    while ((node = current.pop())) {\n      if (!(backtrack && backtrack(node))) {\n        callback(node), (children = node.children);\n        if (children)\n          for (i = 0, n = children.length; i < n; ++i) {\n            next.push(children[i]);\n          }\n      }\n    }\n  } while (next.length);\n\n  return node;\n}\n\n/**\n * Traverses a tree that represents left-child right-sibling\n * @param {Object} tree -- the phylotree.js tree object \n * @return {Object} An edge list that represents the original multi-way tree\n *\n */\nexport function leftChildRightSibling(root) {\n\n  let declareTrueParent = function(n) {\n\n    if(n.children) {\n      // left child is the child\n      n.children[0].data.multiway_parent = n;\n\n      // right child is the sibling\n      n.children[1].data.multiway_parent = n.parent;\n    }\n\n  }\n\n  // First decorate each node with its true parent node\n  postOrder(root, declareTrueParent);\n\n  // return edge list\n  let edge_list = _.map(root.descendants(), n => { \n\n    let source = n.data.multiway_parent; \n    let name = \"unknown\";\n\n    if(source) {\n      name = source.data.name;\n    }\n\n    // In order to get the true name of the infector/infectee, we must traverse\n    // the tree from the multiway_parents node.\n\n    return {\"source\" : n.data.multiway_parent, \"target\" : n } });\n\n  // Construct edge list by new parent-child listing\n  return edge_list;\n\n}\n\n\n\n","import * as _ from \"underscore\";\n\n// These methods are part of the Phylotree object\n\nexport function set_partitions(partitions) {\n  this.partitions = partitions;\n}\n\nexport function get_partitions(attributes) {\n  return this.partitions;\n}\n\n/**\n * Returns T/F whether every branch in the tree has a branch length\n *\n * @returns {Object} true if  every branch in the tree has a branch length\n */\nexport default function has_branch_lengths() {\n\n  let bl = this.branch_length;\n\n  if (bl) {\n    return _.every(this.nodes.descendants(), function(node) {\n      return !node.parent || !_.isUndefined(bl(node));\n    });\n  }\n\n  return false;\n}\n\n/**\n * Returns T/F whether every branch in the tree has a branch length\n *\n * @returns {Object} true if  every branch in the tree has a branch length\n */\nexport function get_branch_lengths() {\n\n  let bl = this.branch_length;\n  return _.map(this.nodes.descendants(), node => { return bl(node)});\n\n}\n\n\nexport function def_branch_length_accessor(_node, new_length) {\n\n  let _node_data = _node.data;\n\n  if (\n    \"attribute\" in _node_data &&\n    _node_data[\"attribute\"] &&\n    _node_data[\"attribute\"].length\n  ) {\n\n    if(new_length > 0) {\n      _node_data[\"attribute\"] = String(new_length);\n    }\n\n    let bl = parseFloat(_node_data[\"attribute\"]);\n    if (!isNaN(bl)) {\n      return Math.max(0, bl);\n    }\n\n  }\n\n  return undefined;\n\n}\n\n/**\n * Get or set branch length accessor.\n *\n * @param {Function} attr Empty if getting, or new branch length accessor if setting.\n * @returns {Object} The branch length accessor if getting, or the current this if setting.\n */\nexport function set_branch_length(attr) {\n  if (!arguments.length) return this.branch_length_accessor;\n  this.branch_length_accessor = attr ? attr : def_branch_length_accessor;\n  return this;\n}\n\n/**\n * Normalizes branch lengths\n */\nexport function normalize(attr) {\n\n  let bl = this.branch_length;\n\n  let branch_lengths = _.map(this.nodes.descendants(), function(node) {\n    if(bl(node)) {\n    return bl(node);\n    } else {\n      return null;\n    }\n  });\n\n  const max_bl = _.max(branch_lengths);\n  const min_bl = _.min(branch_lengths);\n\n  let scaler = function (x) {\n    return (x - min_bl)/(max_bl - min_bl);\n  }\n\n  _.each(this.nodes.descendants(), (node) => {\n      let len = bl(node);\n      if(len) {\n        bl(node, scaler(len));\n      }     \n  });\n\n  return this;\n\n}\n\n\n/**\n * Scales branch lengths\n *\n * @param {Function} function that scales the branches\n */\nexport function scale(scale_by) {\n\n  let bl = this.branch_length;\n\n  _.each(this.nodes.descendants(), (node) => {\n      let len = bl(node);\n      if(len) {\n        bl(node, scale_by(len));\n      }     \n  });\n\n  return this;\n\n}\n\n/**\n * Get or set branch name accessor.\n *\n * @param {Function} attr (Optional) If setting, a function that accesses a branch name\n * from a node.\n * @returns The ``node_label`` accessor if getting, or the current ``this`` if setting.\n */\nexport function branch_name(attr) {\n  if (!arguments.length) return this.node_label;\n  this.node_label = attr ? attr : def_node_label;\n  return this;\n}\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\n\n/**\n* Reroot the tree on the given node.\n*\n* @param {Node} node Node to reroot on.\n* @param {fraction} if specified, partition the branch not into 0.5 : 0.5, but according to \n                   the specified fraction\n                   \n* @returns {Phylotree} The current ``phylotree``.\n*/\nexport function reroot(node, fraction) {\n\n  /** TODO add the option to root in the middle of a branch */\n\n  let nodes = this.nodes.descendants();\n\n  fraction = fraction !== undefined ? fraction : 0.5;\n\n  if (node.parent) {\n\n    var new_json = d3.hierarchy({\n      name: \"new_root\",\n      //__mapped_bl: undefined,\n      \"children\": [{\n          name : node.data.name\n      }]\n    });\n    \n    _.extendOwn (new_json.children[0], node);\n    new_json.children[0].parent = new_json;\n\n    nodes.forEach(n => {\n      n.__mapped_bl = this.branch_length_accessor(n);\n      n.data.__mapped_bl = this.branch_length_accessor(n);\n    });\n\n    this.set_branch_length(function(n) {\n      return n.__mapped_bl || n.data.__mapped_bl;\n    });\n\n\n    let remove_me = node,\n      current_node = node.parent,\n      stashed_bl = _.noop();\n\n    let apportioned_bl =\n      node.data.__mapped_bl === undefined ? undefined : node.data.__mapped_bl * fraction;\n\n    stashed_bl = current_node.data.__mapped_bl;\n\n    current_node.data.__mapped_bl =\n      node.data.__mapped_bl === undefined\n        ? undefined\n        : node.__mapped_bl - apportioned_bl;\n\n    node.data._mapped_bl = apportioned_bl;\n\n    var remove_idx;\n\n    if (current_node.parent) {\n\n      new_json.children.push(current_node);\n\n      while (current_node.parent) {\n        remove_idx = current_node.children.indexOf(remove_me);\n        if (current_node.parent.parent) {\n          current_node.children.splice(remove_idx, 1, current_node.parent);\n        } else {\n          current_node.children.splice(remove_idx, 1);\n        }\n\n        let t = current_node.parent.data.__mapped_bl;\n\n        if (t !== undefined) {\n          current_node.parent.data.__mapped_bl = stashed_bl;\n          stashed_bl = t;\n        }\n        remove_me = current_node;\n        current_node = current_node.parent;\n      }\n      remove_idx = current_node.children.indexOf(remove_me);\n      current_node.children.splice(remove_idx, 1);\n    } else {\n      remove_idx = current_node.children.indexOf(remove_me);\n      current_node.children.splice(remove_idx, 1);\n      stashed_bl = current_node.data.__mapped_bl;\n      remove_me = new_json;\n    }\n\n    // current_node is now old root, and remove_me is the root child we came up\n    // the tree through\n    if (current_node.children.length == 1) {\n      if (stashed_bl) {\n        current_node.children[0].data.__mapped_bl += stashed_bl;\n      }\n      remove_me.children = remove_me.children.concat(current_node.children);\n    } else {\n      let new_node = new d3.hierarchy({ name: \"__reroot_top_clade\", __mapped_bl: stashed_bl });\n      _.extendOwn (new_json.children[0], node);\n      new_node.data.__mapped_bl = stashed_bl;\n      new_node.children = current_node.children.map(function(n) {\n        n.parent = new_node;\n        return n;\n      });\n      new_node.parent = remove_me;\n      remove_me.children.push(new_node);\n     }\n\n  }\n  \n  // need to traverse the nodes and update parents\n  this.update(new_json);\n\n  this.traverse_and_compute(n => {\n    _.each (n.children, (c) => {c.parent = n;})\n  }, \"pre-order\");\n\n\tif(!_.isUndefined(this.display)) {\n\t\t// get container\n\t\tlet container = this.display.container;\n\t\tlet options = this.display.options;\n\t\t// get options\n\t\tdelete this.display;\n  \tthis.render(container, options);\n\t}\n\n  return this;\n\n}\n\nexport function rootpath(attr_name, store_name) {\n  attr_name = attr_name || \"attribute\";\n  store_name = store_name || \"y_scaled\";\n\n  if (\"parent\" in this) {\n    let my_value = parseFloat(this[attr_name]);\n\n    this[store_name] =\n      this.parent[store_name] + (isNaN(my_value) ? 0.1 : my_value);\n  } else {\n    this[store_name] = 0.0;\n  }\n\n  return this[store_name];\n}\n\nexport function path_to_root(node) {\n  let selection = [];\n  while (node) {\n    selection.push(node);\n    node = node.parent;\n  }\n  return selection;\n}\n","export function x_coord(d) {\n  return d.y;\n}\n\nexport function y_coord(d) {\n  return d.x;\n}\n","import * as _ from \"underscore\";\nimport { x_coord, y_coord } from \"./coordinates\";\n\nfunction radial_mapper(r, a, radial_center) {\n  return {\n    x: radial_center + r * Math.sin(a),\n    y: radial_center + r * Math.cos(a)\n  };\n}\n\nfunction cartesian_mapper(x, y, radial_center) {\n  return polar_to_cartesian(x - radial_center, y - radial_center);\n}\n\nfunction polar_to_cartesian(x, y) {\n  let r = Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2));\n  let a = Math.atan2(y, x);\n  return [r, a];\n}\n\nexport function cartesian_to_polar(\n  node,\n  radius,\n  radial_root_offset,\n  radial_center,\n  scales,\n  size\n) {\n  node.radius = radius * (node.radius + radial_root_offset);\n\n  //if (!node.angle) {\n  node.angle = 2 * Math.PI * node.x * scales[0] / size[0];\n  //}\n\n  let radial = radial_mapper(node.radius, node.angle, radial_center);\n\n  node.x = radial.x;\n  node.y = radial.y;\n\n  return node;\n}\n\nexport function draw_arc(points, radial_center) {\n  var start = radial_mapper(points[0].radius, points[0].angle, radial_center),\n    end = radial_mapper(points[0].radius, points[1].angle, radial_center);\n\n  return (\n    \"M \" +\n    x_coord(start) +\n    \",\" +\n    y_coord(start) +\n    \" A \" +\n    points[0].radius +\n    \",\" +\n    points[0].radius +\n    \" 0,0, \" +\n    (points[1].angle > points[0].angle ? 1 : 0) +\n    \" \" +\n    x_coord(end) +\n    \",\" +\n    y_coord(end) +\n    \" L \" +\n    x_coord(points[1]) +\n    \",\" +\n    y_coord(points[1])\n  );\n}\n\nexport function arc_segment_placer(edge, where, radial_center) {\n  var r = radial_mapper(\n    edge.target.radius + (edge.source.radius - edge.target.radius) * where,\n    edge.target.angle,\n    radial_center\n  );\n  return { x: x_coord(r), y: y_coord(r) };\n}\n","import * as d3 from \"d3\";\nimport { x_coord, y_coord } from \"./coordinates\";\n\nexport var draw_line = d3\n  .line()\n  .x(function(d) {\n    return x_coord(d);\n  })\n  .y(function(d) {\n    return y_coord(d);\n  })\n  .curve(d3.curveStepBefore);\n\nexport function line_segment_placer(edge, where) {\n  return {\n    x:\n      x_coord(edge.target) +\n      (x_coord(edge.source) - x_coord(edge.target)) * where,\n    y: y_coord(edge.target)\n  };\n}\n\nexport default draw_line;\n","export function item_tagged(item) {\n  return item.tag || false;\n}\n\nexport function item_selected(item, tag) {\n  return item[tag] || false;\n}\n","import { is_leafnode } from \"../nodes\";\n\nexport const css_classes = {\n  \"tree-container\": \"phylotree-container\",\n  \"tree-scale-bar\": \"tree-scale-bar\",\n  node: \"node\",\n  \"internal-node\": \"internal-node\",\n  \"tagged-node\": \"node-tagged\",\n  \"selected-node\": \"node-selected\",\n  \"collapsed-node\": \"node-collapsed\",\n  \"root-node\": \"root-node\",\n  branch: \"branch\",\n  \"selected-branch\": \"branch-selected\",\n  \"tagged-branch\": \"branch-tagged\",\n  \"tree-selection-brush\": \"tree-selection-brush\",\n  \"branch-tracer\": \"branch-tracer\",\n  clade: \"clade\",\n  node_text: \"phylotree-node-text\"\n};\n\nexport function internal_names(attr) {\n  if (!arguments.length) return this.options[\"internal-names\"];\n  this.options[\"internal-names\"] = attr;\n  return this;\n}\n\nexport function radial(attr) {\n  if (!arguments.length) return this.options[\"is-radial\"];\n  this.options[\"is-radial\"] = attr;\n  return this;\n}\n\nexport function align_tips(attr) {\n  if (!arguments.length) return this.options[\"align-tips\"];\n  this.options[\"align-tips\"] = attr;\n  return this;\n}\n\n/**\n * Return the bubble size of the current node.\n *\n * @param {Node} A node in the phylotree.\n * @returns {Float} The size of the bubble associated to this node.\n */\nexport function node_bubble_size(node) {\n\n  return this.options[\"draw-size-bubbles\"]\n    ? this.relative_node_span(node) * this.scales[0] * 0.25\n    : 0;\n}\n\nexport function shift_tip(d) {\n  if (this.options[\"is-radial\"]) {\n    return [\n      (d.text_align == \"end\" ? -1 : 1) *\n        (this.radius_pad_for_bubbles - d.radius),\n      0\n    ];\n  }\n  if (this.options[\"right-to-left\"]) {\n    return [this.right_most_leaf - d.screen_x, 0];\n  }\n  return [this.right_most_leaf - d.screen_x, 0];\n}\n\nexport function layout_handler(attr) {\n  if (!arguments.length) return this.layout_listener_handler;\n  this.layout_listener_handler = attr;\n  return this;\n}\n\n/**\n * Getter/setter for the selection label. Useful when allowing\n * users to make multiple selections.\n *\n * @param {String} attr (Optional) If setting, the new selection label.\n * @returns The current selection label if getting, or the current ``phylotree`` if setting.\n */\nexport function selection_label(attr) {\n  if (!arguments.length) return this.selection_attribute_name;\n  this.selection_attribute_name = attr;\n  this.sync_edge_labels();\n  return this;\n}\n\n/**\n * Get or set the current node span. If setting, the argument should\n * be a function of a node which returns a number, so that node spans\n * can be determined dynamically. Alternatively, the argument can be the\n * string ``\"equal\"``, to give all nodes an equal span.\n *\n * @param {Function} attr Optional; if setting, the node_span function.\n * @returns The ``node_span`` if getting, or the current ``phylotree`` if setting.\n */\nexport function node_span(attr) {\n  if (!arguments.length) return node_span;\n  if (typeof attr == \"string\" && attr == \"equal\") {\n    node_span = function(d) {\n      return 1;\n    };\n  } else {\n    node_span = attr;\n  }\n  return phylotree;\n}\n\n// List of all selecters that can be used with the restricted-selectable option\nexport var predefined_selecters = {\n  all: d => {\n    return true;\n  },\n  none: d => {\n    return false;\n  },\n  \"all-leaf-nodes\": d => {\n    return is_leafnode(d.target);\n  },\n  \"all-internal-nodes\": d => {\n    return !is_leafnode(d.target);\n  }\n};\n\n/**\n * Getter/setter for the selection callback. This function is called\n * every time the current selection is modified, and its argument is\n * an array of nodes that make up the current selection.\n *\n * @param {Function} callback (Optional) The selection callback function.\n * @returns The current ``selection_callback`` if getting, or the current ``this`` if setting.\n */\nexport function selection_callback(callback) {\n  if (!callback) return this.selection_callback;\n  this.selection_callback = callback;\n  return this;\n}\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\n\nimport { item_tagged, item_selected } from \"./helpers\";\nimport { is_leafnode } from \"../nodes\";\nimport { css_classes } from \"./options\";\n\nexport function shift_tip(d) {\n\n  if (this.radial()) {\n    return [\n      (d.text_align == \"end\" ? -1 : 1) *\n        (this.radius_pad_for_bubbles - d.radius),\n      0\n    ];\n  }\n\n  if (this.options[\"right-to-left\"]) {\n    return [this.right_most_leaf - d.screen_x, 0];\n  }\n\n  return [this.right_most_leaf - d.screen_x, 0];\n\n}\n\nexport function draw_node(container, node, transitions) {\n\n  container = d3.select(container);\n  var is_leaf = is_leafnode(node);\n\n  if (is_leaf) {\n    container = container.attr(\"data-node-name\", node.data.name);\n  }\n\n  let labels = container.selectAll(\"text\").data([node]),\n    tracers = container.selectAll(\"line\");\n\n  if (is_leaf || (this.show_internal_name(node) && !is_node_collapsed(node))) {\n\n    labels = labels\n      .enter()\n      .append(\"text\")\n      .classed(this.css_classes[\"node_text\"], true)\n      .merge(labels)\n      .on(\"click\", this.handle_node_click)\n      .attr(\"dy\", d => {\n        return this.shown_font_size * 0.33;\n      })\n      .text(d => {\n        return this.options[\"show-labels\"] ? this._node_label(d) : \"\";\n      })\n      .style(\"font-size\", d => {\n        return this.ensure_size_is_in_px(this.shown_font_size);\n      });\n\n    if (this.radial()) {\n      labels = labels\n        .attr(\"transform\", d => {\n          return (\n            this.d3_phylotree_svg_rotate(d.text_angle) +\n            this.d3_phylotree_svg_translate(\n              this.align_tips() ? this.shift_tip(d) : null\n            )\n          );\n        })\n        .attr(\"text-anchor\", d => {\n          return d.text_align;\n        });\n    } else {\n      labels = labels.attr(\"text-anchor\", \"start\").attr(\"transform\", d => {\n        if (this.options[\"layout\"] == \"right-to-left\") {\n          return this.d3_phylotree_svg_translate([-20, 0]);\n        }\n        return this.d3_phylotree_svg_translate(\n          this.align_tips() ? this.shift_tip(d) : null\n        );\n      });\n    }\n\n    if (this.align_tips()) {\n      tracers = tracers.data([node]);\n\n      if (transitions) {\n        tracers = tracers\n          .enter()\n          .append(\"line\")\n          .classed(this.css_classes[\"branch-tracer\"], true)\n          .merge(tracers)\n          .attr(\"x1\", d => {\n            return (\n              (d.text_align == \"end\" ? -1 : 1) * this.node_bubble_size(node)\n            );\n          })\n          .attr(\"x2\", 0)\n          .attr(\"y1\", 0)\n          .attr(\"y2\", 0)\n          .attr(\"x2\", d => {\n            if (this.options[\"layout\"] == \"right-to-left\") {\n              return d.screen_x;\n            }\n\n            return this.shift_tip(d)[0];\n          })\n          .attr(\"transform\", d => {\n            return this.d3_phylotree_svg_rotate(d.text_angle);\n          })\n          .attr(\"x2\", d => {\n            if (this.options[\"layout\"] == \"right-to-left\") {\n              return d.screen_x;\n            }\n            return this.shift_tip(d)[0];\n          })\n          .attr(\"transform\", d => {\n            return this.d3_phylotree_svg_rotate(d.text_angle);\n          });\n      } else {\n        tracers = tracers\n          .enter()\n          .append(\"line\")\n          .classed(this.css_classes[\"branch-tracer\"], true)\n          .merge(tracers)\n          .attr(\"x1\", d => {\n            return (\n              (d.text_align == \"end\" ? -1 : 1) * this.node_bubble_size(node)\n            );\n          })\n          .attr(\"y2\", 0)\n          .attr(\"y1\", 0)\n          .attr(\"x2\", d => {\n            return this.shift_tip(d)[0];\n          });\n        tracers.attr(\"transform\", d => {\n          return this.d3_phylotree_svg_rotate(d.text_angle);\n        });\n      }\n    } else {\n      tracers.remove();\n    }\n\n    if (this.options[\"draw-size-bubbles\"]) {\n\n      var shift = this.node_bubble_size(node);\n\n      let circles = container\n        .selectAll(\"circle\")\n        .data([shift])\n        .enter()\n        .append(\"circle\");\n\n      circles.attr(\"r\", function(d) {\n        return d;\n      });\n\n      if (this.shown_font_size >= 5) {\n        labels = labels.attr(\"dx\", d => {\n          return (\n            (d.text_align == \"end\" ? -1 : 1) *\n            ((this.align_tips() ? 0 : shift) + this.shown_font_size * 0.33)\n          );\n        });\n      }\n    } else {\n      if (this.shown_font_size >= 5) {\n        labels = labels.attr(\"dx\", d => {\n          return (d.text_align == \"end\" ? -1 : 1) * this.shown_font_size * 0.33;\n        });\n      }\n    }\n  }\n\n  if (!is_leaf) {\n    let circles = container\n        .selectAll(\"circle\")\n        .data([node])\n        .enter()\n        .append(\"circle\"),\n      radius = this.node_circle_size()(node);\n\n    if (radius > 0) {\n      circles\n        .merge(circles)\n        .attr(\"r\", d => {\n          return Math.min(this.shown_font_size * 0.75, radius);\n        })\n        .on(\"click\", d => {\n          this.handle_node_click(d);\n        });\n    } else {\n      circles.remove();\n    }\n  }\n\n  if (this.node_styler) {\n    this.node_styler(container, node);\n  }\n\n  return node;\n}\n\nexport function update_has_hidden_nodes() {\n  let nodes = this.phylotree.nodes.descendants();\n\n  for (let k = nodes.length - 1; k >= 0; k -= 1) {\n    if (is_leafnode(nodes[k])) {\n      nodes[k].has_hidden_nodes = nodes[k].notshown;\n    } else {\n      nodes[k].has_hidden_nodes = nodes[k].children.reduce(function(p, c) {\n        return c.notshown || p;\n      }, false);\n    }\n  }\n\n  return this;\n}\n\nexport function show_internal_name(node) {\n\n  const i_names = this.internal_names();\n\n  if (i_names) {\n    if (typeof i_names === \"function\") {\n      return i_names(node);\n    }\n    return i_names;\n  }\n\n  return false;\n}\n\n/**\n * Get or set the current node span. If setting, the argument should\n * be a function of a node which returns a number, so that node spans\n * can be determined dynamically. Alternatively, the argument can be the\n * string ``\"equal\"``, to give all nodes an equal span.\n *\n * @param {Function} attr Optional; if setting, the node_span function.\n * @returns The ``node_span`` if getting, or the current ``phylotree`` if setting.\n */\nexport function node_span(attr) {\n  if (!arguments.length) return this.node_span;\n  if (typeof attr == \"string\" && attr == \"equal\") {\n    this.node_span = function(d) {\n      return 1;\n    };\n  } else {\n    this.node_span = attr;\n  }\n  return this;\n}\n\nexport function reclass_node(node) {\n\n  let class_var = css_classes[is_leafnode(node) ? \"node\" : \"internal-node\"];\n\n  if (item_tagged(node)) {\n    class_var += \" \" + css_classes[\"tagged-node\"];\n  }\n\n  if (item_selected(node, this.selection_attribute_name)) {\n    class_var += \" \" + css_classes[\"selected-node\"];\n  }\n\n  if (!node[\"parent\"]) {\n    class_var += \" \" + css_classes[\"root-node\"];\n  }\n\n  if (is_node_collapsed(node) || has_hidden_nodes(node)) {\n    class_var += \" \" + css_classes[\"collapsed-node\"];\n  }\n\n  return class_var;\n}\n\nexport function node_visible(node) {\n  return !(node.hidden || node.notshown || false);\n}\n\nexport function node_notshown(node) {\n  return node.notshown;\n}\n\nexport function has_hidden_nodes(node) {\n  return node.has_hidden_nodes || false;\n}\n\nexport function is_node_collapsed(node) {\n  return node.collapsed || false;\n}\n\nexport function node_css_selectors(css_classes) {\n  return [\n    css_classes[\"node\"],\n    css_classes[\"internal-node\"],\n    css_classes[\"collapsed-node\"],\n    css_classes[\"tagged-node\"],\n    css_classes[\"root-node\"]\n  ].reduce(function(p, c, i, a) {\n    return (p += \"g.\" + c + (i < a.length - 1 ? \",\" : \"\"));\n  }, \"\");\n}\n\nexport function internal_label(callback, respect_existing) {\n\n  this.phylotree.clear_internal_nodes(respect_existing);\n\n  for (var i = self.nodes.length - 1; i >= 0; i--) {\n    var d = self.nodes[i];\n    if (!(is_leafnode(d) || item_selected(d, selection_attribute_name))) {\n      d[selection_attribute_name] = callback(d.children);\n    }\n  }\n\n  this.modify_selection(function(d, callback) {\n    if (is_leafnode(d.target)) {\n      return d.target[selection_attribute_name];\n    }\n    return d.target[selection_attribute_name];\n  });\n}\n\nexport function def_node_label(_node) {\n\n  _node = _node.data;\n\n  if (is_leafnode(_node)) {\n    return _node.name || \"\";\n  }\n\n  if (this.show_internal_name(_node)) {\n    return _node.name;\n  }\n\n  return \"\";\n\n}\n\n/**\n * Get or set node_label accessor.\n *\n * @param {Function} attr (Optional) If setting, a function that accesses a branch name\n * from a node.\n * @returns The ``node_label`` accessor if getting, or the current ``this`` if setting.\n */\nexport function node_label(attr) {\n  if (!arguments.length) return this._node_label;\n  this._node_label = attr ? attr : def_node_label;\n\tthis.update();\n  return this;\n}\n\n\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\nimport { is_node_collapsed } from \"./nodes\";\n\nexport function clade_css_selectors(css_classes) {\n  return [css_classes[\"clade\"]].reduce(function(p, c, i, a) {\n    return (p += \"path.\" + c + (i < a.length - 1 ? \",\" : \"\"));\n  }, \"\");\n}\n\nexport function update_collapsed_clades(transitions) {\n  let enclosure = this.svg.selectAll(\".\" + this.css_classes[\"tree-container\"]);\n\n  let collapsed_clades = enclosure\n    .selectAll(clade_css_selectors(this.css_classes))\n    .data(\n      this.phylotree.nodes.descendants().filter(is_node_collapsed),\n      function(d) {\n        return d.id || (d.id = ++node_id);\n      }\n    );\n\n  let spline = function() {};\n  let spline_f = _.noop();\n\n  // Collapse radial differently\n  if (this.radial()) {\n    spline = d3\n      .line()\n      .curve(d3.curveBasis)\n      .y(function(d) {\n        return d[0];\n      })\n      .x(function(d) {\n        return d[1];\n      });\n\n    spline_f = function(coord, i, d, init_0, init_1) {\n      if (i) {\n        return [\n          d.screen_y + (coord[0] - init_0) / 50,\n          d.screen_x + (coord[1] - init_1) / 50\n        ];\n      } else {\n        return [d.screen_y, d.screen_x];\n      }\n    };\n  } else {\n    spline = d3\n      .line()\n      .curve(d3.curveBasis)\n      .y(function(d) {\n        return d[0];\n      })\n      .x(function(d) {\n        return d[1];\n      });\n\n    spline_f = function(coord, i, d, init_0, init_1) {\n      if (i) {\n        return [\n          d.screen_y + (coord[0] - init_0) / 50,\n          d.screen_x + (coord[1] - init_1) / 50\n        ];\n      } else {\n        return [d.screen_y, d.screen_x];\n      }\n    };\n  }\n\n  collapsed_clades\n    .exit()\n    .each(function(d) {\n      d.collapsed_clade = null;\n    })\n    .remove();\n\n  if (transitions) {\n    collapsed_clades\n      .enter()\n      .insert(\"path\", \":first-child\")\n      .attr(\"class\", this.css_classes[\"clade\"])\n      .merge(collapsed_clades)\n      .attr(\"d\", function(d) {\n        if (d.collapsed_clade) {\n          return d.collapsed_clade;\n        }\n\n        let init_0 = d.collapsed[0][0];\n        let init_1 = d.collapsed[0][1];\n\n        // #1 return spline(d.collapsed.map(spline_f, d, init_0, init_1));\n        return spline(\n          d.collapsed.map(function(coord, i) {\n            return spline_f(coord, i, d, init_0, init_1);\n          })\n        );\n      })\n      .attr(\"d\", function(d) {\n        return (d.collapsed_clade = spline(d.collapsed));\n      });\n  } else {\n    collapsed_clades\n      .enter()\n      .insert(\"path\", \":first-child\")\n      .attr(\"class\", this.css_classes[\"clade\"])\n      .merge(collapsed_clades)\n      .attr(\"d\", function(d) {\n        return (d.collapsed_clade = spline(d.collapsed));\n      });\n  }\n}\n","import * as d3 from \"d3\";\nimport { item_tagged, item_selected } from \"./helpers\";\nimport { css_classes } from \"./options\";\n\nexport function draw_edge(container, edge, transition) {\n\n  container = d3.select(container);\n\n  container = container\n    .attr(\"class\", d => {\n      return this.reclass_edge(d);\n    })\n    .on(\"click\", d => {\n      this.modify_selection([d.target], this.selection_attribute_name);\n\n      //console.log(\"click called, this\", this, d);\n      if (this.selection_callback) {\n        this.selection_callback(this, d.target);\n      }\n    });\n\n  let new_branch_path = this.draw_branch([edge.source, edge.target]);\n\n  if (transition) {\n\n    if (container.datum().existing_path) {\n      container = container.attr(\"d\", function(d) {\n        return d.existing_path;\n      });\n    }\n\n    container = container.attr(\"d\", new_branch_path);\n\n  } else {\n    container = container.attr(\"d\", new_branch_path);\n  }\n\n  edge.existing_path = new_branch_path;\n\n  var bl = this.phylotree.branch_length_accessor(edge.target);\n\n  if (bl !== undefined) {\n    var haz_title = container.selectAll(\"title\");\n\n    if (haz_title.empty()) {\n      haz_title = container.append(\"title\");\n    }\n    haz_title.text(\"Length = \" + bl);\n  } else {\n    container.selectAll(\"title\").remove();\n  }\n\n  if (this.edge_styler) {\n    this.edge_styler(container, edge, transition);\n  }\n\n  return this.phylotree;\n\n}\n\nexport function reclass_edge(edge) {\n\n  let class_var = css_classes[\"branch\"];\n\n  if (item_tagged(edge)) {\n    class_var += \" \" + css_classes[\"tagged-branch\"];\n  }\n\n  if (item_selected(edge, this.selection_attribute_name)) {\n    class_var += \" \" + css_classes[\"selected-branch\"];\n  }\n\n  return class_var;\n\n}\n\nexport function sync_edge_labels() {\n\n  this.phylotree.links.forEach(d => {\n    d[this.selection_attribute_name] =\n      d.target[this.selection_attribute_name] || false;\n    d.tag = d.target.tag || false;\n  });\n\n  if (this.count_handler()) {\n\n    let counts = {};\n\n    counts[\n      this.selection_attribute_name\n    ] = this.phylotree.links.reduce((p, c) => {\n      return p + (c[this.selection_attribute_name] ? 1 : 0);\n    }, 0);\n\n    counts[\"tagged\"] = this.phylotree.links.reduce(function(p, c) {\n      return p + (item_tagged(c) ? 1 : 0);\n    }, 0);\n\n    this.count_update(this, counts, this.count_handler());\n\n  }\n\n}\n\nexport function edge_visible(edge) {\n  return !(edge.target.hidden || edge.target.notshown || false);\n}\n\nexport function edge_css_selectors(css_classes) {\n  return [\n    css_classes[\"branch\"],\n    css_classes[\"selected-branch\"],\n    css_classes[\"tagged-branch\"]\n  ].reduce(function(p, c, i, a) {\n    return (p += \"path.\" + c + (i < a.length - 1 ? \",\" : \"\"));\n  }, \"\");\n}\n\nexport function place_along_an_edge (e, where) {\n    return this.edge_placer (e, where);\n}\n","import * as d3 from \"d3\";\nimport { is_leafnode } from \"../nodes\";\nimport { css_classes } from \"./options\";\n\nlet d3_layout_phylotree_event_id = \"phylotree.event\";\n\n/**\n * Toggle collapsed view of a given node. Either collapses a clade into\n * a smaller blob for viewing large trees, or expands a node that was\n * previously collapsed.\n *\n * @param {Node} node The node to toggle.\n * @returns {Phylotree} The current ``phylotree``.\n */\nexport function toggle_collapse(node) {\n  if (node.collapsed) {\n    node.collapsed = false;\n\n    let unhide = function(n) {\n      if (!is_leafnode(n)) {\n        if (!n.collapsed) {\n          n.children.forEach(unhide);\n        }\n      }\n      n.hidden = false;\n    };\n\n    unhide(node);\n  } else {\n    node.collapsed = true;\n  }\n\n  this.placenodes();\n  return this;\n}\n\nexport function resize_svg(tree, svg, tr) {\n\n  let sizes = this.size;\n\n  if (this.radial()) {\n    let pad_radius = this.pad_width(),\n      vertical_offset =\n        this.options[\"top-bottom-spacing\"] != \"fit-to-size\"\n          ? this.pad_height()\n          : 0;\n\n    sizes = [\n      sizes[1] + 2 * pad_radius,\n      sizes[0] + 2 * pad_radius + vertical_offset\n    ];\n\n    if (svg) {\n      svg\n        .selectAll(\".\" + css_classes[\"tree-container\"])\n        .attr(\n          \"transform\",\n          \"translate (\" +\n            pad_radius +\n            \",\" +\n            (pad_radius + vertical_offset) +\n            \")\"\n        );\n    }\n  } else {\n\n    sizes = [\n      sizes[0] +\n        (this.options[\"top-bottom-spacing\"] != \"fit-to-size\"\n          ? this.pad_height()\n          : 0),\n      sizes[1] +\n        (this.options[\"left-right-spacing\"] != \"fit-to-size\"\n          ? this.pad_width()\n          : 0)\n    ];\n\n  }\n\n\n  if (svg) {\n\n    if (tr) {\n      svg = svg.transition(100);\n    }\n\n    svg.attr(\"height\", sizes[0]).attr(\"width\", sizes[1]);\n\n  }\n\n  this.size = sizes;\n\n  return sizes;\n\n}\n\nexport function rescale(scale, attr_name) {\n  attr_name = attr_name || \"y_scaled\";\n  if (attr_name in this) {\n    this[attr_name] *= scale;\n  }\n}\n\nexport function trigger_refresh(tree) {\n\n  var event = new CustomEvent(d3_layout_phylotree_event_id, {\n    detail: [\"refresh\", tree]\n  });\n\n  document.dispatchEvent(event);\n\n}\n\nexport function count_update(tree, counts) {\n  var event = new CustomEvent(d3_layout_phylotree_event_id, {\n    detail: [\"count_update\", counts, tree.count_handler()]\n  });\n  document.dispatchEvent(event);\n}\n\nexport function d3_phylotree_trigger_layout(tree) {\n  var event = new CustomEvent(d3_layout_phylotree_event_id, {\n    detail: [\"layout\", tree, tree.layout_handler()]\n  });\n  document.dispatchEvent(event);\n}\n\nexport function d3_phylotree_event_listener(event) {\n  switch (event.detail[0]) {\n    case \"refresh\":\n      event.detail[1].refresh();\n      break;\n    case \"count_update\":\n    case \"layout\":\n      event.detail[2](event.detail[1]);\n      break;\n  }\n  return true;\n}\n\nexport function d3_phylotree_add_event_listener() {\n  document.addEventListener(\n    d3_layout_phylotree_event_id,\n    d3_phylotree_event_listener,\n    false\n  );\n}\n\nexport function d3_phylotree_svg_translate(x) {\n  if (x && (x[0] !== null || x[1] !== null))\n    return (\n      \"translate (\" +\n      (x[0] !== null ? x[0] : 0) +\n      \",\" +\n      (x[1] !== null ? x[1] : 0) +\n      \") \"\n    );\n\n  return \"\";\n}\n\nexport function d3_phylotree_svg_rotate(a) {\n  if (a !== null) {\n    return \"rotate (\" + a + \") \";\n  }\n  return \"\";\n}\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\nimport * as events from \"./events\";\nimport { is_leafnode } from \"../nodes\";\nimport { is_node_collapsed, has_hidden_nodes } from \"./nodes\";\nimport { predefined_selecters } from \"./options\";\n\nlet d3_layout_phylotree_context_menu_id = \"d3_layout_phylotree_context_menu\";\n\nexport function node_dropdown_menu(node, container, phylotree, options) {\n  let menu_object = d3\n    .select(container)\n    .select(\"#\" + d3_layout_phylotree_context_menu_id);\n\n  if (menu_object.empty()) {\n    menu_object = d3\n      .select(container)\n      .append(\"div\")\n      .attr(\"id\", d3_layout_phylotree_context_menu_id)\n      .attr(\"class\", \"dropdown-menu\")\n      .attr(\"role\", \"menu\");\n  }\n\n  menu_object.selectAll(\"a\").remove();\n  menu_object.selectAll(\"h6\").remove();\n  menu_object.selectAll(\"div\").remove();\n\n  if (node) {\n    if (\n      !_.some([\n        Boolean(node.menu_items),\n        options[\"hide\"],\n        options[\"selectable\"],\n        options[\"collapsible\"]\n      ]) ||\n      !options[\"show-menu\"]\n    )\n      return;\n    if (!is_leafnode(node)) {\n      if (options[\"collapsible\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(is_node_collapsed(node) ? \"Expand Subtree\" : \"Collapse Subtree\")\n          .on(\"click\", d => {\n            menu_object.style(\"display\", \"none\");\n            this.toggle_collapse(node).update();\n          });\n        if (options[\"selectable\"]) {\n          menu_object.append(\"div\").attr(\"class\", \"dropdown-divider\");\n          menu_object\n            .append(\"h6\")\n            .attr(\"class\", \"dropdown-header\")\n            .text(\"Toggle selection\");\n        }\n      }\n\n      if (options[\"selectable\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"All descendant branches\")\n          .on(\"click\", function(d) {\n            menu_object.style(\"display\", \"none\");\n            phylotree.modify_selection(\n              phylotree.select_all_descendants(node, true, true)\n            );\n          });\n\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"All terminal branches\")\n          .on(\"click\", function(d) {\n            menu_object.style(\"display\", \"none\");\n            phylotree.modify_selection(\n              phylotree.select_all_descendants(node, true, false)\n            );\n          });\n\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"All internal branches\")\n          .on(\"click\", function(d) {\n            menu_object.style(\"display\", \"none\");\n            phylotree.modify_selection(\n              phylotree.select_all_descendants(node, false, true)\n            );\n          });\n      }\n    }\n\n    if (node.parent) {\n      if (options[\"selectable\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"Incident branch\")\n          .on(\"click\", function(d) {\n            menu_object.style(\"display\", \"none\");\n            phylotree.modify_selection([node]);\n          });\n\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"Path to root\")\n          .on(\"click\", d => {\n            menu_object.style(\"display\", \"none\");\n            this.modify_selection(this.phylotree.path_to_root(node));\n          });\n\n        if (options[\"reroot\"] || options[\"hide\"]) {\n          menu_object.append(\"div\").attr(\"class\", \"dropdown-divider\");\n        }\n      }\n\n      if (options[\"reroot\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"Reroot on this node\")\n          .on(\"click\", d => {\n            menu_object.style(\"display\", \"none\");\n            this.phylotree.reroot(node);\n            this.refresh().update();\n          });\n      }\n\n      if (options[\"hide\"]) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(\"Hide this \" + (is_leafnode(node) ? \"node\" : \"subtree\"))\n          .on(\"click\", d => {\n            menu_object.style(\"display\", \"none\");\n            this.modify_selection([node], \"notshown\", true, true)\n              .update_has_hidden_nodes()\n              .update();\n          });\n      }\n    }\n\n    if (has_hidden_nodes(node)) {\n      menu_object\n        .append(\"a\")\n        .attr(\"class\", \"dropdown-item\")\n        .attr(\"tabindex\", \"-1\")\n        .text(\"Show all descendant nodes\")\n        .on(\"click\", function(d) {\n          menu_object.style(\"display\", \"none\");\n          phylotree\n            .modify_selection(\n              phylotree.select_all_descendants(node, true, true),\n              \"notshown\",\n              true,\n              true,\n              \"false\"\n            )\n            .update_has_hidden_nodes()\n            .update();\n        });\n    }\n\n    // now see if we need to add user defined menus\n\n    var has_user_elements = [];\n    if (\"menu_items\" in node && typeof node[\"menu_items\"] === \"object\") {\n      node[\"menu_items\"].forEach(function(d) {\n        if (d.length == 3) {\n          if (!d[2] || d[2](node)) {\n            has_user_elements.push([d[0], d[1]]);\n          }\n        }\n      });\n    }\n\n    if (has_user_elements.length) {\n      const show_divider_options = [\n        options[\"hide\"],\n        options[\"selectable\"],\n        options[\"collapsible\"]\n      ];\n\n      if (_.some(show_divider_options)) {\n        menu_object.append(\"div\").attr(\"class\", \"dropdown-divider\");\n      }\n\n      has_user_elements.forEach(function(d) {\n        menu_object\n          .append(\"a\")\n          .attr(\"class\", \"dropdown-item\")\n          .attr(\"tabindex\", \"-1\")\n          .text(constant(d[0])(node))\n          .on(\"click\", _.partial(d[1], node));\n      });\n    }\n\n    let tree_container = $(container);\n    let coordinates = d3.mouse(tree_container[0]);\n\n    menu_object\n      .style(\"position\", \"absolute\")\n      .style(\"left\", \"\" + coordinates[0] + \"px\")\n      .style(\"top\", \"\" + coordinates[1] + \"px\")\n      .style(\"display\", \"block\");\n  } else {\n    menu_object.style(\"display\", \"none\");\n  }\n}\n\nexport function add_custom_menu(node, name, callback, condition) {\n  if (!(\"menu_items\" in node)) {\n    node[\"menu_items\"] = [];\n  }\n  if (\n    !node[\"menu_items\"].some(function(d) {\n      return d[0] == name && d[1] == callback && d[2] == condition;\n    })\n  ) {\n    node[\"menu_items\"].push([name, callback, condition]);\n  }\n}\n\n/**\n *\n * Modify the current selection, via functional programming.\n *\n * @param {Function} node_selecter A function to apply to each node, which\n * determines whether they become part of the current selection. Alternatively,\n * if ``restricted-selectable`` mode is enabled, a string describing one of\n * the pre-defined restricted-selectable options.\n * @param {String} attr (Optional) The selection attribute to modify.\n * @param {Boolean} place (Optional) Whether or not ``placenodes`` should be called.\n * @param {Boolean} skip_refresh (Optional) Whether or not a refresh is called.\n * @param {String} mode (Optional) Can be ``\"toggle\"``, ``\"true\"``, or ``\"false\"``.\n * @returns The current ``this``.\n *\n */\nexport function modify_selection(\n  node_selecter,\n  attr,\n  place,\n  skip_refresh,\n  mode\n) {\n  attr = attr || this.selection_attribute_name;\n  mode = mode || \"toggle\";\n\n  // check if node_selecter is a value of pre-defined selecters\n\n  if (this.options[\"restricted-selectable\"].length) {\n    // the selection must be from a list of pre-determined selections\n    if (_.contains(_.keys(predefined_selecters), node_selecter)) {\n      node_selecter = predefined_selecters[node_selecter];\n    } else {\n      return;\n    }\n  }\n\n  if (\n    (this.options[\"restricted-selectable\"] || this.options[\"selectable\"]) &&\n    !this.options[\"binary-selectable\"]\n  ) {\n    var do_refresh = false;\n\n    if (typeof node_selecter === \"function\") {\n      this.phylotree.links.forEach(function(d) {\n        var select_me = node_selecter(d);\n        d[attr] = d[attr] || false;\n        if (d[attr] != select_me) {\n          d[attr] = select_me;\n          do_refresh = true;\n          d.target[attr] = select_me;\n        }\n      });\n    } else {\n      node_selecter.forEach(function(d) {\n        var new_value;\n        switch (mode) {\n          case \"true\":\n            new_value = true;\n            break;\n          case \"false\":\n            new_value = false;\n            break;\n          default:\n            new_value = !d[attr];\n            break;\n        }\n\n        if (d[attr] != new_value) {\n          d[attr] = new_value;\n          do_refresh = true;\n        }\n      });\n\n      this.links.forEach(function(d) {\n        d[attr] = d.target[attr];\n      });\n    }\n\n    var counts;\n\n    if (do_refresh) {\n      if (!skip_refresh) {\n        events.trigger_refresh(this);\n      }\n      if (this.count_handler()) {\n        counts = {};\n        counts[attr] = this.phylotree.links.reduce(function(p, c) {\n          return p + (c[attr] ? 1 : 0);\n        }, 0);\n        events.count_update(this, counts, this.count_handler());\n      }\n\n      if (place) {\n        this.placenodes();\n      }\n    }\n  } else if (this.options[\"binary-selectable\"]) {\n    if (typeof node_selecter === \"function\") {\n      this.phylotree.links.forEach(function(d) {\n        var select_me = node_selecter(d);\n        d[attr] = d[attr] || false;\n\n        if (d[attr] != select_me) {\n          d[attr] = select_me;\n          do_refresh = true;\n          d.target[attr] = select_me;\n        }\n\n        this.options[\"attribute-list\"].forEach(function(type) {\n          if (type != attr && d[attr] === true) {\n            d[type] = false;\n            d.target[type] = false;\n          }\n        });\n      });\n    } else {\n      node_selecter.forEach(function(d) {\n        var new_value;\n        new_value = !d[attr];\n\n        if (d[attr] != new_value) {\n          d[attr] = new_value;\n          do_refresh = true;\n        }\n      });\n\n      this.phylotree.links.forEach(function(d) {\n        d[attr] = d.target[attr];\n        this.phylotree.options[\"attribute-list\"].forEach(function(type) {\n          if (type != attr && d[attr] !== true) {\n            d[type] = false;\n            d.target[type] = false;\n          }\n        });\n      });\n    }\n\n    if (do_refresh) {\n      if (!skip_refresh) {\n        events.trigger_refresh(this);\n      }\n      if (this.count_handler()) {\n        counts = {};\n        counts[attr] = this.phylotree.links.reduce(function(p, c) {\n          return p + (c[attr] ? 1 : 0);\n        }, 0);\n        this.count_update(this, counts, this.count_handler());\n      }\n\n      if (place) {\n        this.placenodes();\n      }\n    }\n  }\n\n  if (this.selection_callback && attr != \"tag\") {\n    this.selection_callback(this.get_selection());\n  }\n\n  this.refresh();\n  return this;\n}\n\n/**\n * Get nodes which are currently selected.\n *\n * @returns {Array} An array of nodes that match the current selection.\n */\nexport function get_selection() {\n  return []; // the code below doesn't seem to work\n  return this.phylotree.nodes.filter(d => {\n    return d[this.selection_attribute_name];\n  });\n}\n\n/**\n * Select all descendents of a given node, with options for selecting\n * terminal/internal nodes.\n *\n * @param {Node} node The node whose descendents should be selected.\n * @param {Boolean} terminal Whether to include terminal nodes.\n * @param {Boolean} internal Whther to include internal nodes.\n * @returns {Array} An array of selected nodes.\n */\nexport function select_all_descendants(node, terminal, internal) {\n  let selection = [];\n\n  function sel(d) {\n    if (is_leafnode(d)) {\n      if (terminal) {\n        if (d != node) selection.push(d);\n      }\n    } else {\n      if (internal) {\n        if (d != node) selection.push(d);\n      }\n      d.children.forEach(sel);\n    }\n  }\n\n  sel(node);\n  return selection;\n}\n\n/**\n * Getter/setter for the selection callback. This function is called\n * every time the current selection is modified, and its argument is\n * an array of nodes that make up the current selection.\n *\n * @param {Function} callback (Optional) The selection callback function.\n * @returns The current ``selection_callback`` if getting, or the current ``this`` if setting.\n */\nexport function selection_callback(callback) {\n  if (!callback) return this.selection_callback;\n  this.selection_callback = callback;\n  return this;\n}\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\n\nimport { draw_arc, cartesian_to_polar, arc_segment_placer } from \"./radial\";\nimport { default as draw_line, line_segment_placer } from \"./cartesian\";\nimport { is_leafnode } from \"../nodes\";\nimport { x_coord, y_coord } from \"./coordinates\";\nimport * as clades from \"./clades\";\nimport * as render_nodes from \"./nodes\";\nimport * as render_edges from \"./edges\";\nimport * as events from \"./events\";\nimport { css_classes } from \"./options\";\nimport * as opt from \"./options\";\nimport * as menus from \"./menus\";\n\n// replacement for d3.functor\nfunction constant(x) {\n  return function() {\n    return x;\n  };\n}\n\nclass TreeRender {\n\n  constructor(phylotree, container, options = {}) {\n    this.css_classes = css_classes;\n    this.phylotree = phylotree;\n    this.container = container;\n    this.separation = function(_node, _previous) {\n      return 0;\n    };\n\n    this._node_label = this.def_node_label;\n    this.svg = null;\n    this.selection_callback = null;\n    this.scales = [1, 1];\n    this.size = [1, 1];\n    this.fixed_width = [30, 20];\n    this.font_size = 12;\n    this.scale_bar_font_size = 12;\n    this.offsets = [0, this.font_size / 2];\n\n    this.draw_branch = draw_line;\n    this.draw_scale_bar = null;\n    this.edge_placer = line_segment_placer;\n    this.count_listener_handler = function() {};\n    this.layout_listener_handler = function() {};\n    this.node_styler = undefined;\n    this.edge_styler = undefined;\n    this.shown_font_size = this.font_size;\n    this.selection_attribute_name = \"selected\";\n    this.right_most_leaf = 0;\n    this.label_width = 0;\n    this.radial_center = 0;\n    this.radius = 1;\n    this.radius_pad_for_bubbles = 0;\n\n    this.rescale_node_span = 1;\n    this.node_span = function(_node) {\n      return 1;\n    };\n    this.relative_node_span = function(_node) {\n      return this.node_span(_node) / this.rescale_node_span;\n    };\n\n    let default_options = {\n      layout: \"left-to-right\",\n      logger: console,\n      branches: \"step\",\n      scaling: true,\n      bootstrap: false,\n      \"color-fill\": true,\n      \"internal-names\": false,\n      selectable: true,\n      // restricted-selectable can take an array of predetermined\n      // selecters that are defined in phylotree.predefined_selecters\n      // only the defined functions will be allowed when selecting\n      // branches\n      \"restricted-selectable\": false,\n      collapsible: true,\n      \"left-right-spacing\": \"fixed-step\", //'fit-to-size',\n      \"top-bottom-spacing\": \"fixed-step\",\n      \"left-offset\": 0,\n      \"right-offset\": 0,\n      \"show-scale\": \"top\",\n      // currently not implemented to support any other positioning\n      \"draw-size-bubbles\": false,\n      \"binary-selectable\": false,\n      \"is-radial\": false,\n      \"attribute-list\": [],\n      \"max-radius\": 768,\n      \"annular-limit\": 0.38196601125010515,\n      compression: 0.2,\n      \"align-tips\": false,\n      \"maximum-per-node-spacing\": 100,\n      \"minimum-per-node-spacing\": 2,\n      \"maximum-per-level-spacing\": 100,\n      \"minimum-per-level-spacing\": 10,\n      node_circle_size: constant(3),\n      transitions: null,\n      brush: true,\n      reroot: true,\n      hide: true,\n      \"label-nodes-with-name\": false,\n      zoom: false,\n      \"show-menu\": true,\n      \"show-labels\": true\n    };\n\n    this.ensure_size_is_in_px = function(value) {\n      return typeof value === \"number\" ? value + \"px\" : value;\n    };\n\n    this.options = _.defaults(options, default_options);\n\n    this.width = this.options.width || 800;\n    this.height = this.options.height || 600;\n\n    this.rescale_node_span =\n      this.phylotree.nodes.children\n        .map(d => {\n          if (is_leafnode(d) || this.show_internal_name(d))\n            return this.node_span(d);\n        })\n        .reduce(function(p, c) {\n          return Math.min(c, p || 1e200);\n        }, null) || 1;\n\n    this.initialize_svg(this.container);\n    this.links = this.phylotree.nodes.links();\n    this.update();\n  }\n\n  pad_height() {\n    if (this.draw_scale_bar) {\n      return this.scale_bar_font_size + 25;\n    }\n\n    return 0;\n  }\n\n  pad_width() {\n    // reset label_width\n    this.label_width = this._label_width(this.shown_font_size);\n\n    const _label_width = this.options[\"show-labels\"] ? this.label_width : 0;\n    return this.offsets[1] + this.options[\"left-offset\"]\n      + this.options[\"right-offset\"] // TODO TEST THIS\n      + _label_width;\n  }\n\n  /**\n   * Collapses a given node.\n   *\n   * @param {Node} node A node to be collapsed.\n   */\n  collapse_node(n) {\n    if (!render_nodes.is_node_collapsed(n)) {\n      n.collapsed = true;\n    }\n  }\n\n  /**\n   * Get or set the size of tree in pixels.\n   *\n   * @param {Array} attr (optional) An array of the form ``[height, width]``.\n   * @returns {Phylotree} The current ``size`` array if getting, or the current ``phylotree``\n   * if setting.\n   */\n  set_size(attr) {\n\n    if (!arguments.length) {\n      return this.size;\n    }\n\n    let phylo_attr = attr;\n\n    if (this.options[\"top-bottom-spacing\"] != \"fixed-step\") {\n      this.size[0] = phylo_attr[0];\n    }\n    if (this.options[\"left-right-spacing\"] != \"fixed-step\") {\n      this.size[1] = phylo_attr[1];\n    }\n\n    return this;\n\n  }\n\n  /**\n   * Getter/setter for the SVG element for the Phylotree to be rendered in.\n   *\n   * @param {d3-selection} svg_element (Optional) SVG element to render within, selected by D3.\n   * @returns The selected SVG element if getting, or the current ``phylotree`` if setting.`\n   */\n  initialize_svg(svg_element) {\n    if (!arguments.length) return this.svg;\n\n    if (this.svg !== svg_element) {\n      d3.select(svg_element).select(\"svg\").remove();\n\n      this.svg = d3\n        .select(svg_element)\n        .append(\"svg\")\n        .attr(\"width\", this.width)\n        .attr(\"height\", this.height);\n\n      this.set_size([this.height, this.width]);\n\n      if (this.css_classes[\"tree-container\"] == \"phylotree-container\") {\n        this.svg.selectAll(\"*\").remove();\n        this.svg.append(\"defs\");\n      }\n\n      d3.select(this.container).on(\n        \"click\",\n        d => {\n          this.handle_node_click(null);\n        },\n        true\n      );\n    }\n\n    return this;\n  }\n\n  update_layout(new_json, do_hierarchy) {\n\n    if (do_hierarchy) {\n      this.nodes = d3.hierarchy(new_json);\n      this.nodes.each(function(d) {\n        d.id = null;\n      });\n    }\n\n    this.update();\n    this.sync_edge_labels();\n\n  }\n\n  /**\n   * Update the current phylotree, i.e., alter the svg\n   * elements.\n   *\n   * @param {Boolean} transitions (Optional) Toggle whether transitions should be shown.\n   * @returns The current ``phylotree``.\n   */\n  update(transitions) {\n\n    var self = this;\n\n    if (!this.svg) return this;\n\n    this.placenodes();\n\n    transitions = this.transitions(transitions);\n\n    let node_id = 0;\n\n    let enclosure = this.svg\n      .selectAll(\".\" + css_classes[\"tree-container\"])\n      .data([0]);\n\n    enclosure = enclosure\n      .enter()\n      .append(\"g\")\n      .attr(\"class\", css_classes[\"tree-container\"])\n      .merge(enclosure)\n      .attr(\"transform\", d => {\n        return this.d3_phylotree_svg_translate([\n          this.offsets[1] + this.options[\"left-offset\"]\n,\n          this.pad_height()\n        ]);\n      });\n\n    if (this.draw_scale_bar) {\n\n      let scale_bar = this.svg\n        .selectAll(\".\" + css_classes[\"tree-scale-bar\"])\n        .data([0]);\n\n      scale_bar\n        .enter()\n        .append(\"g\")\n        .attr(\"class\", css_classes[\"tree-scale-bar\"])\n        .style(\"font-size\", this.ensure_size_is_in_px(this.scale_bar_font_size))\n        .merge(scale_bar)\n        .attr(\"transform\", d => {\n          return this.d3_phylotree_svg_translate([\n            this.offsets[1] + this.options[\"left-offset\"],\n            this.pad_height() - 10\n          ]);\n        })\n        .call(this.draw_scale_bar);\n\n      scale_bar.selectAll(\"text\").style(\"text-anchor\", \"end\");\n    } else {\n      this.svg.selectAll(\".\" + css_classes[\"tree-scale-bar\"]).remove();\n    }\n\n    enclosure = this.svg\n      .selectAll(\".\" + css_classes[\"tree-container\"])\n      .data([0]);\n\n    this.update_collapsed_clades(transitions);\n\n    let drawn_links = enclosure\n      .selectAll(render_edges.edge_css_selectors(css_classes))\n      .data(this.links.filter(render_edges.edge_visible), d => {\n        return d.target.id || (d.target.id = ++node_id);\n      });\n\n    if (transitions) {\n      drawn_links.exit().remove();\n    } else {\n      drawn_links.exit().remove();\n    }\n\n    drawn_links = drawn_links\n      .enter()\n      .insert(\"path\", \":first-child\")\n      .merge(drawn_links)\n      .each(function(d) {\n        self.draw_edge(this, d, transitions);\n      });\n\n    let drawn_nodes = enclosure\n      .selectAll(render_nodes.node_css_selectors(css_classes))\n      .data(\n        this.phylotree.nodes.descendants().filter(render_nodes.node_visible),\n        d => {\n          return d.id || (d.id = ++node_id);\n        }\n      );\n\n    drawn_nodes.exit().remove();\n\n    drawn_nodes = drawn_nodes\n      .enter()\n      .append(\"g\")\n      .attr(\"class\", this.reclass_node)\n      .merge(drawn_nodes)\n      .attr(\"transform\", d => {\n        const should_shift =\n          this.options[\"layout\"] == \"right-to-left\" && is_leafnode(d);\n\n        d.screen_x = x_coord(d);\n        d.screen_y = y_coord(d);\n\n        return this.d3_phylotree_svg_translate([\n          should_shift ? 0 : d.screen_x,\n          d.screen_y\n        ]);\n      })\n      .each(function(d) {\n        self.draw_node(this, d, transitions);\n      })\n      .attr(\"transform\", d => {\n        if (!_.isUndefined(d.screen_x) && !_.isUndefined(d.screen_y)) {\n          return \"translate(\" + d.screen_x + \",\" + d.screen_y + \")\";\n        }\n      });\n\n    if (this.options[\"label-nodes-with-name\"]) {\n      drawn_nodes = drawn_nodes.attr(\"id\", d => {\n        return \"node-\" + d.name;\n      });\n    }\n\n    this.resize_svg(this.phylotree, this.svg, transitions);\n\n    if (this.options[\"brush\"]) {\n\n      var brush = enclosure\n        .selectAll(\".\" + css_classes[\"tree-selection-brush\"])\n        .data([0])\n        .enter()\n        .insert(\"g\", \":first-child\")\n        .attr(\"class\", css_classes[\"tree-selection-brush\"]);\n\n      var brush_object = d3\n        .brush()\n        .on(\"brush\", () => {\n          var extent = d3.event.target.extent(),\n            shown_links = this.links.filter(render_edges.edge_visible),\n            selected_links = shown_links\n              .filter((d, i) => {\n                return (\n                  d.source.screen_x >= extent[0][0] &&\n                  d.source.screen_x <= extent[1][0] &&\n                  d.source.screen_y >= extent[0][1] &&\n                  d.source.screen_y <= extent[1][1] &&\n                  d.target.screen_x >= extent[0][0] &&\n                  d.target.screen_x <= extent[1][0] &&\n                  d.target.screen_y >= extent[0][1] &&\n                  d.target.screen_y <= extent[1][1]\n                );\n              })\n              .map(d => {\n                return d.target;\n              });\n\n          this.modify_selection(\n            this.phylotree.links.map(d => {\n              return d.target;\n            }),\n            \"tag\",\n            false,\n            selected_links.length > 0,\n            \"false\"\n          );\n\n          this.modify_selection(selected_links, \"tag\", false, false, \"true\");\n        })\n        .on(\"end\", () => {\n          //brush.call(d3.event.target.clear());\n        });\n\n      brush.call(brush_object);\n\n    }\n\n    this.sync_edge_labels();\n\n    if (this.options[\"zoom\"]) {\n\n      let zoom = d3.zoom().scaleExtent([0.1, 10]).on(\"zoom\", () => {\n\n        var translate = [];\n        translate[0] = \n          d3.event.transform.x +\n          this.offsets[1] + this.options[\"left-offset\"] - this.options[\"right-offset\"];\n        translate[1] = d3.event.transform.y + this.pad_height();\n\n        d3\n          .select(\".\" + css_classes[\"tree-container\"])\n          .attr(\n            \"transform\",\n            \"translate(\" + translate + \")scale(\" + d3.event.transform.k + \")\"\n          );\n      });\n\n      this.svg.call(zoom);\n\n    }\n\n    return this;\n\n  }\n\n  _handle_single_node_layout(\n    a_node,\n    last_node,\n    last_span,\n    is_under_collapsed_parent,\n    save_x\n  ) {\n\n    let _node_span = this.node_span(a_node) / this.rescale_node_span;\n    // compute the relative size of nodes (0,1)\n    // sum over all nodes is 1\n\n    this.x = a_node.x =\n      this.x +\n      this.separation(last_node, a_node) +\n      (last_span + _node_span) * 0.5;\n\n    // separation is a user-settable callback to add additional spacing on nodes\n    this._extents[1][1] = Math.max(this._extents[1][1], a_node.y);\n    this._extents[1][0] = Math.min(\n      this._extents[1][0],\n      a_node.y - _node_span * 0.5\n    );\n\n    if (is_under_collapsed_parent) {\n      this._extents[0][1] = Math.max(\n        this._extents[0][1],\n        save_x +\n          (a_node.x - save_x) * this.options[\"compression\"] +\n          this.save_span +\n          (_node_span * 0.5 + this.separation(last_node, a_node)) *\n            this.options[\"compression\"]\n      );\n    } else {\n      this._extents[0][1] = Math.max(\n        this._extents[0][1],\n        this.x + _node_span * 0.5 + this.separation(last_node, a_node)\n      );\n    }\n\n    last_node = a_node;\n    last_span = _node_span;\n\n    this.last_node = last_node;\n    this.last_span = last_span;\n\n    return [last_node, last_span];\n  }\n\n  tree_layout(a_node) {\n    /**\n            for each node: \n                y: the y coordinate is root to tip\n                    (left to right in cladogram layout, radius is radial layout\n                x : the x coordinate is top-most to bottom-most \n                    (top to bottom in cladogram layout, angle in radial layout)\n                \n                \n         @return the x-coordinate of a_node or undefined in the node is not displayed\n                 (hidden or under a collapsed node)\n        */\n\n    // do not layout hidden nodes\n    if (render_nodes.node_notshown(a_node)) {\n      return undefined;\n    }\n\n    let is_leaf = is_leafnode(a_node);\n\n    // the next four members are radial layout options\n    a_node.text_angle = null; // the angle at which text is being laid out\n    a_node.text_align = null; // css alignment option for node labels\n    a_node.radius = null; // radial layout radius\n    a_node.angle = null; // radial layout angle (in radians)\n\n    /** determine the root-to-tip location of this node;\n            \n      the root node receives the co-ordinate of 0\n      \n      if the tree has branch lengths, then the placement of each node is simply the \n      total branch length to the root\n      \n      if the tree has no branch lengths, all leaves get the same depth (\"number of internal nodes on the deepest path\")\n      and all internal nodes get the depth in integer units of the # of internal nodes on the path to the root + 1\n        \n    */\n\n    let undef_BL = false;\n\n    /** _extents computes a bounding box for the tree (initially NOT in screen \n            coordinates)\n\n        all account for node sizes\n\n        _extents [1][0] -- the minimum x coordinate (breadth)\n        _extents [1][1] -- the maximum y coordinate (breadth)\n        _extents [1][0] -- the minimum y coordinate (root-to-tip, or depthwise)\n        _extents [1][1] -- the maximum y coordinate (root-to-tip, or depthwise)\n\n    */\n\n    let last_node = null;\n\n    // last node laid out in the top bottom hierarchy\n    let last_span = 0;\n    let is_under_collapsed_parent = false;\n\n    if (a_node[\"parent\"]) {\n      if (this.do_scaling) {\n        if (undef_BL) {\n          return 0;\n        }\n\n        a_node.y = this.phylotree.branch_length_accessor(a_node);\n\n        if (typeof a_node.y === \"undefined\") {\n          undef_BL = true;\n          return 0;\n        }\n\n        a_node.y += a_node.parent.y;\n      } else {\n        a_node.y = is_leaf ? this.max_depth : a_node.depth;\n      }\n    } else {\n      this.x = 0.0;\n      // the span of the last node laid out in the top to bottom hierarchy\n      a_node.y = 0.0;\n    }\n\n    /** the next block has to do with top-to-bottom spacing of nodes **/\n\n    if (is_leaf) {\n      // displayed internal nodes are handled in `process_internal_node`\n      this._handle_single_node_layout(\n        a_node,\n        last_node,\n        last_span,\n        is_under_collapsed_parent,\n        0.0\n      );\n    }\n\n    if (!is_leaf) {\n      // for internal nodes\n      if (\n        render_nodes.is_node_collapsed(a_node) &&\n        !is_under_collapsed_parent\n      ) {\n        // collapsed node\n        let save_x = this.x;\n        this.save_span = this.last_span * 0.5;\n        is_under_collapsed_parent = true;\n        this.process_internal_node(a_node);\n        is_under_collapsed_parent = false;\n\n        if (typeof a_node.x === \"number\") {\n          a_node.x =\n            save_x +\n            (a_node.x - save_x) * this.options[\"compression\"] +\n            this.save_span;\n\n          a_node.collapsed = [[a_node.x, a_node.y]];\n\n          var map_me = n => {\n            n.hidden = true;\n\n            if (is_leafnode(n)) {\n              this.x = n.x =\n                save_x +\n                (n.x - save_x) * this.options[\"compression\"] +\n                this.save_span;\n\n              a_node.collapsed.push([n.x, n.y]);\n            } else {\n              n.children.map(map_me);\n            }\n          };\n\n          this.x = save_x;\n          map_me(a_node);\n\n          a_node.collapsed.splice(1, 0, [save_x, a_node.y]);\n          a_node.collapsed.push([this.x, a_node.y]);\n          a_node.collapsed.push([a_node.x, a_node.y]);\n          a_node.hidden = false;\n        }\n      } else {\n        // normal node, or under a collapsed parent\n        this.process_internal_node(a_node);\n      }\n    }\n\n    return a_node.x;\n  }\n\n  process_internal_node(a_node) {\n    /** \n            decide if the node will be shown, and compute its top-to-bottom (breadthwise)\n            placement \n        */\n\n    let count_undefined = 0;\n\n    if (this.show_internal_name(a_node)) {\n      // do in-order traversal to allow for proper internal node spacing\n      // (x/2) >> 0 is integer division\n      let half_way = (a_node.children.length / 2) >> 0;\n      let displayed_children = 0;\n      let managed_to_display = false;\n\n      for (let child_id = 0; child_id < a_node.children.length; child_id++) {\n        let child_x = this.tree_layout(a_node.children[child_id]).bind(this);\n\n        if (typeof child_x == \"number\") {\n          displayed_children++;\n        }\n\n        if (displayed_children >= half_way && !managed_to_display) {\n          this._handle_single_node_layout(a_node);\n          managed_to_display = true;\n        }\n      }\n\n      if (displayed_children == 0) {\n        a_node.notshown = true;\n        a_node.x = undefined;\n      } else {\n        if (!managed_to_display) {\n          this._handle_single_node_layout(a_node);\n        }\n      }\n    } else {\n      // postorder layout\n      a_node.x = a_node.children\n        .map(this.tree_layout.bind(this))\n        .reduce((a, b) => {\n          if (typeof b == \"number\") return a + b;\n          count_undefined += 1;\n          return a;\n        }, 0.0);\n\n      if (count_undefined == a_node.children.length) {\n        a_node.notshown = true;\n        a_node.x = undefined;\n      } else {\n        a_node.x /= a_node.children.length - count_undefined;\n      }\n    }\n  }\n\n  do_lr(at_least_one_dimension_fixed) {\n\n    if (this.radial() && at_least_one_dimension_fixed) {\n      this.offsets[1] = 0;\n    }\n\n\n    if (this.options[\"left-right-spacing\"] == \"fixed-step\") {\n\n      this.size[1] = this.max_depth * this.fixed_width[1];\n\n      this.scales[1] =\n        (this.size[1] - this.offsets[1] - this.options[\"left-offset\"] - this.options[\"right-offset\"]) /  //  TEST right offset here\n        this._extents[1][1];\n\n      this.label_width = this._label_width(this.shown_font_size);\n\n      if (this.radial()) {\n        this.label_width *= 2;\n      }\n    } else {\n\n      this.label_width = this._label_width(this.shown_font_size);\n\n      at_least_one_dimension_fixed = true;\n\n      let available_width =\n        this.size[1] - this.offsets[1] - this.options[\"left-offset\"] - this.options[\"right-offset\"]; // TEST this\n\n      if (available_width * 0.5 < this.label_width) {\n        this.shown_font_size *= available_width * 0.5 / this.label_width;\n        this.label_width = available_width * 0.5;\n      }\n\n      this.scales[1] =\n        (this.size[1] -\n          this.offsets[1] -\n          (this.options[\"left-offset\"] + this.options['right-offset']) - // TEST this\n          this.label_width) /\n        this._extents[1][1];\n\n    }\n  }\n\n  /**\n   * Place the current nodes, i.e., determine their coordinates based\n   * on current settings.\n   *\n   * @returns The current ``phylotree``.\n   */\n  placenodes() {\n\n    this._extents = [[0, 0], [0, 0]];\n\n    let x = 0.0,\n      last_span = 0;\n\n    (this.save_x = x), (this.save_span = last_span * 0.5);\n\n    this.do_scaling = this.options[\"scaling\"];\n    let undef_BL = false;\n\n    this.is_under_collapsed_parent = false;\n    this.max_depth = 1;\n\n    // Set initial x\n    this.phylotree.nodes.x = this.tree_layout(\n      this.phylotree.nodes,\n      this.do_scaling\n    );\n\n    this.max_depth = d3.max(this.phylotree.nodes.descendants(), n => {\n      return n.depth;\n    });\n\n    if (this.do_scaling && undef_BL) {\n\n      // requested scaling, but some branches had no branch lengths\n      // redo layout without branch lengths\n      this.do_scaling = false;\n      this.phylotree.nodes.x = this.tree_layout(this.phylotree.nodes);\n\n    }\n\n    let at_least_one_dimension_fixed = false;\n\n    this.draw_scale_bar = this.options[\"show-scale\"] && this.do_scaling;\n\n    // this is a hack so that phylotree.pad_height would return ruler spacing\n    this.offsets[1] = Math.max(\n        this.font_size,\n        -this._extents[1][0] * this.fixed_width[0]\n      );\n\n\n    if (this.options[\"top-bottom-spacing\"] == \"fixed-step\") {\n      this.size[0] = this._extents[0][1] * this.fixed_width[0];\n      this.scales[0] = this.fixed_width[0];\n    } else {\n      this.scales[0] = (this.size[0] - this.pad_height()) / this._extents[0][1];\n      at_least_one_dimension_fixed = true;\n    }\n\n    this.shown_font_size = Math.min(this.font_size, this.scales[0]);\n\n    if (this.radial()) {\n      // map the nodes to polar coordinates\n      this.draw_branch = _.partial(draw_arc, _, this.radial_center);\n      this.edge_placer = arc_segment_placer;\n\n      let last_child_angle = null,\n        last_circ_position = null,\n        last_child_radius = null,\n        min_radius = 0,\n        effective_span = this._extents[0][1] * this.scales[0];\n\n      let compute_distance = function(r1, r2, a1, a2, annular_shift) {\n        annular_shift = annular_shift || 0;\n        return Math.sqrt(\n          (r2 - r1) * (r2 - r1) +\n            2 *\n              (r1 + annular_shift) *\n              (r2 + annular_shift) *\n              (1 - Math.cos(a1 - a2))\n        );\n      };\n\n      let max_r = 0;\n\n      this.phylotree.nodes.each(d => {\n\n        let my_circ_position = d.x * this.scales[0];\n        d.angle = 2 * Math.PI * my_circ_position / effective_span;\n        d.text_angle = d.angle - Math.PI / 2;\n        d.text_angle = d.text_angle > 0 && d.text_angle < Math.PI;\n        d.text_align = d.text_angle ? \"end\" : \"start\";\n        d.text_angle = (d.text_angle ? 180 : 0) + d.angle * 180 / Math.PI;\n\n      });\n\n      this.do_lr(at_least_one_dimension_fixed);\n\n      this.phylotree.nodes.each(d => {\n        d.radius = d.y * this.scales[1] / this.size[1];\n        max_r = Math.max(d.radius, max_r);\n      });\n\n      let annular_shift = 0;\n\n      this.phylotree.nodes.each(d => {\n        if (!d.children) {\n          let my_circ_position = d.x * this.scales[0];\n          if (last_child_angle !== null) {\n            let required_spacing = my_circ_position - last_circ_position,\n              radial_dist = compute_distance(\n                d.radius,\n                last_child_radius,\n                d.angle,\n                last_child_angle,\n                annular_shift\n              );\n\n            let local_mr =\n              radial_dist > 0\n                ? required_spacing / radial_dist\n                : 10 * this.options[\"max-radius\"];\n\n            if (local_mr > this.options[\"max-radius\"]) {\n              // adjust the annular shift\n              let dd = required_spacing / this.options[\"max-radius\"],\n                b = d.radius + last_child_radius,\n                c =\n                  d.radius * last_child_radius -\n                  (dd * dd -\n                    (last_child_radius - d.radius) *\n                      (last_child_radius - d.radius)) /\n                    2 /\n                    (1 - Math.cos(last_child_angle - d.angle)),\n                st = Math.sqrt(b * b - 4 * c);\n\n              annular_shift = Math.min(\n                this.options[\"annular-limit\"] * max_r,\n                (-b + st) / 2\n              );\n              min_radius = this.options[\"max-radius\"];\n            } else {\n              min_radius = Math.max(min_radius, local_mr);\n            }\n          }\n\n          last_child_angle = d.angle;\n          last_circ_position = my_circ_position;\n          last_child_radius = d.radius;\n        }\n      });\n\n      this.radius = Math.min(\n        this.options[\"max-radius\"],\n        Math.max(effective_span / 2 / Math.PI, min_radius)\n      );\n\n      if (at_least_one_dimension_fixed) {\n        this.radius = Math.min(\n          this.radius,\n          (Math.min(effective_span, this._extents[1][1] * this.scales[1]) -\n            this.label_width) *\n            0.5 -\n            this.radius * annular_shift\n        );\n      }\n\n      this.radial_center = this.radius_pad_for_bubbles = this.radius;\n      this.draw_branch = _.partial(draw_arc, _, this.radial_center);\n\n      let scaler = 1;\n\n      if (annular_shift) {\n        scaler = max_r / (max_r + annular_shift);\n        this.radius *= scaler;\n      }\n\n      this.phylotree.nodes.each(d => {\n        cartesian_to_polar(\n          d,\n          this.radius,\n          annular_shift,\n          this.radial_center,\n          this.scales,\n          this.size\n        );\n\n        max_r = Math.max(max_r, d.radius);\n\n        if (this.options[\"draw-size-bubbles\"]) {\n          this.radius_pad_for_bubbles = Math.max(\n            this.radius_pad_for_bubbles,\n            d.radius + this.node_bubble_size(d)\n          );\n        } else {\n          this.radius_pad_for_bubbles = Math.max(\n            this.radius_pad_for_bubbles,\n            d.radius\n          );\n        }\n\n        if (d.collapsed) {\n          d.collapsed = d.collapsed.map(p => {\n            let z = {};\n            z.x = p[0];\n            z.y = p[1];\n            z = cartesian_to_polar(\n              z,\n              this.radius,\n              annular_shift,\n              this.radial_center,\n              this.scales,\n              this.size\n            );\n            return [z.x, z.y];\n          });\n\n          let last_point = d.collapsed[1];\n\n          d.collapsed = d.collapsed.filter(function(p, i) {\n            if (i < 3 || i > d.collapsed.length - 4) return true;\n            if (\n              Math.sqrt(\n                Math.pow(p[0] - last_point[0], 2) +\n                  Math.pow(p[1] - last_point[1], 2)\n              ) > 3\n            ) {\n              last_point = p;\n              return true;\n            }\n            return false;\n          });\n        }\n      });\n\n      this.size[0] = this.radial_center + this.radius / scaler;\n      this.size[1] = this.radial_center + this.radius / scaler;\n\n    } else {\n\n      this.do_lr();\n\n      this.draw_branch = draw_line;\n      this.edge_placer = line_segment_placer;\n      this.right_most_leaf = 0;\n\n      this.phylotree.nodes.each(d => {\n\n        d.x *= this.scales[0];\n        d.y *= this.scales[1]*.8;\n\n        if (this.options[\"layout\"] == \"right-to-left\") {\n          d.y = this._extents[1][1] * this.scales[1] - d.y;\n        }\n\n        if (is_leafnode(d)) {\n          this.right_most_leaf = Math.max(\n            this.right_most_leaf,\n            d.y + this.node_bubble_size(d)\n          );\n        }\n\n        if (d.collapsed) {\n\n          d.collapsed.map(p => {\n            return [(p[0] *= this.scales[0]), (p[1] *= this.scales[1])];\n          });\n\n          let last_x = d.collapsed[1][0];\n\n          d.collapsed = d.collapsed.filter(function(p, i) {\n            if (i < 3 || i > d.collapsed.length - 4) return true;\n            if (p[0] - last_x > 3) {\n              last_x = p[0];\n              return true;\n            }\n            return false;\n          });\n\n        }\n      });\n    }\n\n    if (this.draw_scale_bar) {\n\n      let domain_limit, range_limit;\n\n      if (this.radial()) {\n        range_limit = Math.min(this.radius / 5, 50);\n        domain_limit = Math.pow(\n          10,\n          Math.ceil(\n            Math.log(this._extents[1][1] * range_limit / this.radius) /\n              Math.log(10)\n          )\n        );\n\n        range_limit = domain_limit * (this.radius / this._extents[1][1]);\n\n        if (range_limit < 30) {\n          let stretch = Math.ceil(30 / range_limit);\n          range_limit *= stretch;\n          domain_limit *= stretch;\n        }\n      } else {\n        domain_limit = this._extents[1][1];\n        range_limit =\n          this.size[1] - this.offsets[1] - this.options[\"left-offset\"] - this.options[\"right-offset\"];\n      }\n\n      let scale = d3\n          .scaleLinear()\n          .domain([0, domain_limit])\n          .range([this.shown_font_size, this.shown_font_size + range_limit]),\n        scaleTickFormatter = d3.format(\".2g\");\n\n      this.draw_scale_bar = d3.axisTop().scale(scale).tickFormat(function(d) {\n\n        if (d === 0) {\n          return \"\";\n        }\n\n        return scaleTickFormatter(d);\n\n      });\n\n      if (this.radial()) {\n        this.draw_scale_bar.tickValues([domain_limit]);\n      } else {\n        let round = function(x, n) {\n          return n ? Math.round(x * (n = Math.pow(10, n))) / n : Math.round(x);\n        };\n\n        let my_ticks = scale.ticks();\n        my_ticks = my_ticks.length > 1 ? my_ticks[1] : my_ticks[0];\n\n        this.draw_scale_bar.ticks(\n          Math.min(\n            10,\n            round(\n              range_limit /\n                (this.shown_font_size *\n                  scaleTickFormatter(my_ticks).length *\n                  0.8),\n              0\n            )\n          )\n        );\n      }\n\n    } else {\n      this.draw_scale_bar = null;\n    }\n\n    return this;\n  }\n\n  /**\n   * Get or set spacing in the x-direction.\n   *\n   * @param {Number} attr (Optional), the new spacing value if setting.\n   * @param {Boolean} skip_render (Optional), whether or not a refresh should be performed.\n   * @returns The current ``spacing_x`` value if getting, or the current ``phylotree`` if setting.\n   */\n  spacing_x(attr, skip_render) {\n    if (!arguments.length) return this.fixed_width[0];\n\n    if (\n      this.fixed_width[0] != attr &&\n      attr >= this.options[\"minimum-per-node-spacing\"] &&\n      attr <= this.options[\"maximum-per-node-spacing\"]\n    ) {\n      this.fixed_width[0] = attr;\n      if (!skip_render) {\n        this.placenodes();\n      }\n    }\n\n    return this;\n  }\n\n  /**\n   * Get or set spacing in the y-direction.\n   *\n   * @param {Number} attr (Optional), the new spacing value if setting.\n   * @param {Boolean} skip_render (Optional), whether or not a refresh should be performed.\n   * @returns The current ``spacing_y`` value if getting, or the current ``phylotree`` if setting.\n   */\n  spacing_y(attr, skip_render) {\n\n    if (!arguments.length) return this.fixed_width[1];\n\n    if (\n      this.fixed_width[1] != attr &&\n      attr >= this.options[\"minimum-per-level-spacing\"] &&\n      attr <= this.options[\"maximum-per-level-spacing\"]\n    ) {\n      this.fixed_width[1] = attr;\n      if (!skip_render) {\n        this.placenodes();\n      }\n    }\n    return this;\n  }\n\n  _label_width(_font_size) {\n\n    _font_size = _font_size || this.shown_font_size;\n    let width = 0;\n\n    this.phylotree.nodes\n      .descendants()\n      .filter(render_nodes.node_visible)\n      .forEach(node => {\n\n        let node_width = 12 + this._node_label(node).length * _font_size * 0.8;\n\n        if (node.angle !== null) {\n          node_width *= Math.max(\n            Math.abs(Math.cos(node.angle)),\n            Math.abs(Math.sin(node.angle))\n          );\n        }\n        width = Math.max(node_width, width);\n      });\n\n    return width;\n\n  }\n\n  /**\n   * Get or set font size.\n   *\n   * @param {Function} attr Empty if getting, or new font size if setting.\n   * @returns The current ``font_size`` accessor if getting, or the current ``phylotree`` if setting.\n   */\n  font_size(attr) {\n    if (!arguments.length) return this.font_size;\n    this.font_size = attr === undefined ? 12 : attr;\n    return this;\n  }\n\n  scale_bar_font_size(attr) {\n    if (!arguments.length) return this.scale_bar_font_size;\n    this.scale_bar_font_size = attr === undefined ? 12 : attr;\n    return this;\n  }\n\n  node_circle_size(attr, attr2) {\n    if (!arguments.length) return this.options[\"node_circle_size\"];\n    this.options[\"node_circle_size\"] = constant(attr === undefined ? 3 : attr);\n    return this;\n  }\n\n  css(opt) {\n    if (arguments.length === 0) return this.css_classes;\n\n    if (arguments.length > 2) {\n      var arg = {};\n      arg[opt[0]] = opt[1];\n      return this.css(arg);\n    }\n\n    for (var key in css_classes) {\n      if (key in opt && opt[key] != css_classes[key]) {\n        css_classes[key] = opt[key];\n      }\n    }\n\n    return this;\n  }\n\n  transitions(arg) {\n    if (arg !== undefined) {\n      return arg;\n    }\n\n    if (this.options[\"transitions\"] !== null) {\n      return this.options[\"transitions\"];\n    }\n\n    return this.phylotree.nodes.descendants().length <= 300;\n  }\n\n  /**\n   * Get or set CSS classes.\n   *\n   * @param {Object} opt Keys are the CSS class to toggle and values are\n   * the parameters for that CSS class.\n   * @param {Boolean} run_update (optional) Whether or not the tree should update.\n   * @returns The current ``phylotree``.\n   */\n  css_classes(opt, run_update) {\n    if (!arguments.length) return this.css_classes;\n\n    let do_update = false;\n\n    for (var key in css_classes) {\n      if (key in opt && opt[key] != this.css_classes[key]) {\n        do_update = true;\n        this.css_classes[key] = opt[key];\n      }\n    }\n\n    if (run_update && do_update) {\n      this.layout();\n    }\n\n    return this;\n  }\n\n  /**\n   * Lay out the tree within the SVG.\n   *\n   * @param {Boolean} transitions Specify whether or not transitions should occur.\n   * @returns The current ``phylotree``.\n   */\n  layout(transitions) {\n    if (this.svg) {\n      this.svg.selectAll(\n        \".\" +\n          this.css_classes[\"tree-container\"] +\n          \",.\" +\n          this.css_classes[\"tree-scale-bar\"] +\n          \",.\" +\n          this.css_classes[\"tree-selection-brush\"]\n      );\n\n      //.remove();\n      this.d3_phylotree_trigger_layout(this);\n      return this.update();\n    }\n\n    this.d3_phylotree_trigger_layout(this);\n    return this;\n  }\n\n  handle_node_click(node) {\n    this.node_dropdown_menu(node, this.container, this, this.options);\n  }\n\n  refresh() {\n    if (this.svg) {\n      // for re-entrancy\n      let enclosure = this.svg.selectAll(\n        \".\" + this.css_classes[\"tree-container\"]\n      );\n\n      let edges = enclosure\n        .selectAll(render_edges.edge_css_selectors(this.css_classes))\n        .attr(\"class\", this.reclass_edge.bind(this));\n\n      if (this.edge_styler) {\n        edges.each(function(d) {\n          this.edge_styler(d3.select(this), d);\n        });\n      }\n\n      //let nodes = this.enclosure\n      //  .selectAll(inspector.node_css_selectors(this.css_classes))\n      //  .attr(\"class\", this.phylotree.reclass_node);\n\n      //if (this.node_styler) {\n      //  nodes.each(function(d) {\n      //    this.node_styler(d3.select(this), d);\n      //  });\n      //}\n    }\n\n    return this;\n  }\n\n  count_handler(attr) {\n    if (!arguments.length) return this.count_listener_handler;\n    this.count_listener_handler = attr;\n    return this;\n  }\n\n  /**\n   * Get or set node styler. If setting, pass a function of two arguments,\n   * ``element`` and ``data``. ``data`` exposes the underlying node so that\n   * its attributes can be referenced. These can be used to apply styles to\n   * ``element``, which will be a D3 selection corresponding to the SVG element\n   * that makes up the current node.\n   * ``transition`` is the third argument which indicates that there is an ongoing\n   * d3 transition in progress\n   *\n   * @param {Function} attr - Optional; if setting, the node styler function to be set.\n   * @returns The ``node_styler`` function if getting, or the current ``phylotree`` if setting.\n   */\n  style_nodes(attr) {\n    if (!arguments.length) return this.node_styler;\n    this.node_styler = attr;\n    return this;\n  }\n\n  /**\n   * Get or set edge styler. If setting, pass a function of two arguments,\n   * ``element`` and ``data``. ``data`` exposes the underlying edge so that\n   * its attributes can be referenced. These can be used to apply styles to\n   * ``element``, which will be a D3 selection corresponding to the SVG element\n   * that makes up the current edge.\n   *\n   * Note that, in accordance with the D3 hierarchy layout, edges will have\n   * a ``source`` and ``target`` field, corresponding to the nodes that make up\n   * up the associated branch.\n   *\n   * @param {Function} attr - Optional; if setting, the node styler function to be set.\n   * @returns The ``edge_styler`` function if getting, or the current ``phylotree`` if setting.\n   */\n  style_edges(attr) {\n    if (!arguments.length) return this.edge_styler;\n    this.edge_styler = attr.bind(this);\n    return this;\n  }\n\n  item_selected(item, tag) {\n    return item[tag] || false;\n  }\n\n\n}\n\n_.extend(TreeRender.prototype, clades);\n_.extend(TreeRender.prototype, render_nodes);\n_.extend(TreeRender.prototype, render_edges);\n_.extend(TreeRender.prototype, events);\n_.extend(TreeRender.prototype, menus);\n_.extend(TreeRender.prototype, opt);\n\nexport default TreeRender;\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\n\nimport { default as parser_registry } from \"./formats/registry\";\nimport { default as nexml_parser } from \"./formats/nexml\";\nimport { default as newick_parser, get_newick } from \"./formats/newick\";\n\nimport * as nexus from \"./formats/nexus\";\n\nimport { default as phyloxml_parser } from \"./formats/phyloxml\";\nimport { default as max_parsimony } from \"./max-parsimony\";\nimport { leftChildRightSibling, postOrder, preOrder, default as inOrder } from \"./traversal\";\n\nimport {\n  default as has_branch_lengths,\n  get_branch_lengths,\n  def_branch_length_accessor,\n  set_branch_length,\n  branch_name,\n  normalize,\n  scale\n} from \"./branches\";\n\nimport * as node_operations from \"./nodes\";\nimport * as rooting from \"./rooting\";\nimport { default as TreeRender } from \"./render/draw\";\n\nfunction resort_children(comparator, start_node, filter) {\n  // ascending\n  this.nodes\n    .sum(function(d) {\n      return d.value;\n    })\n    .sort(comparator);\n\n  // if a tree is rendered in the DOM\n  if (this.display) {\n    this.display.update_layout(this.nodes);\n    this.display.update();\n  }\n\n  return this;\n}\n\n/**\n * Return most recent common ancestor of a pair of nodes.\n * @returns An array of strings, comprising each tag that was read.\n */\nfunction mrca() {\n\n  var mrca_nodes, mrca;\n\n  if (arguments.length == 1) {\n    mrca_nodes = arguments[0];\n  } else {\n    mrca_nodes = Array.from(arguments);\n  }\n\n  mrca_nodes = mrca_nodes.map(function(mrca_node) {\n    return typeof mrca_node == \"string\" ? mrca_node : mrca_node.name;\n  });\n\n  this.traverse_and_compute(function(node) {\n    if (!node.children) {\n      node.mrca = _.intersection([node.name], mrca_nodes);\n    } else if (!node.parent) {\n      if (!mrca) {\n        mrca = node;\n      }\n    } else {\n      node.mrca = _.union(...node.descendants().map(child => child.mrca));\n      if (!mrca && node.mrca.length == mrca_nodes.length) {\n        mrca = node;\n      }\n    }\n  });\n\n  return mrca;\n\n}\n\n/**\n * An instance of a phylotree. Sets event listeners, parses tags, and creates links\n * that represent branches.\n *\n * @param {Object} nwk - A Newick string, PhyloXML string, or hierarchical JSON representation of a phylogenetic tree.\n * @param {Object} options\n * - boostrap_values\n * - type - format type\n * @returns {Phylotree} phylotree - itself, following the builder pattern.\n */\nlet Phylotree = class {\n\n  constructor(nwk, options = {}) {\n\n    this.newick_string = \"\";\n\n    this.nodes = [];\n    this.links = [];\n    this.parsed_tags = [];\n    this.partitions = [];\n    this.branch_length_accessor = def_branch_length_accessor;\n    this.branch_length = def_branch_length_accessor;\n    this.logger = options.logger || console;\n    this.selection_attribute_name = \"selected\";\n\n    // initialization\n    var bootstrap_values = options.bootstrap_values || \"\",\n      type = options.type || undefined,\n      _node_data = [],\n      self = this;\n\n    // If the type is a string, check the parser_registry\n    if (_.isString(type)) {\n      if (type in parser_registry) {\n        _node_data = parser_registry[type](nwk, options);\n      } else {\n        // Hard failure\n        self.logger.error(\n          \"type \" +\n            type +\n            \" not in registry! Available types are \" +\n            _.keys(parser_registry)\n        );\n      }\n    } else if (_.isFunction(type)) {\n      // If the type is a function, try executing the function\n      try {\n        _node_data = type(nwk, options);\n      } catch (e) {\n        // Hard failure\n        self.logger.error(\"Could not parse custom format!\");\n      }\n    } else {\n      // this builds children and links;\n      if (nwk.name == \"root\") {\n        // already parsed by phylotree.js\n        _node_data = { json: nwk, error: null };\n      } else if (typeof nwk != \"string\") {\n        // old default\n        _node_data = nwk;\n      } else if (nwk.contentType == \"application/xml\") {\n        // xml\n        _node_data = phyloxml_parser(nwk);\n      } else {\n        // newick string\n        this.newick_string = nwk;\n        _node_data = newick_parser(nwk, bootstrap_values);\n      }\n\n    }\n\n    if (!_node_data[\"json\"]) {\n\n      self.nodes = [];\n\n    } else {\n\n      self.nodes = d3.hierarchy(_node_data.json);\n\n      // Parse tags\n      let _parsed_tags = {};\n\n      self.nodes.each(node => {\n        if (node.data.annotation) {\n          _parsed_tags[node.data.annotation] = true;\n        }\n      });\n\n      self.parsed_tags = Object.keys(_parsed_tags);\n\n    }\n\n    self.links = self.nodes.links();\n\n    return self;\n\n  }\n\n  /*\n    Export the nodes of the tree with all local keys to JSON\n    The return will be an array of nodes in the specified traversal_type\n    ('post-order' : default, 'pre-order', or 'in-order')\n    with parents and children referring to indices in that array\n\n  */\n  json(traversal_type) {\n\n    var index = 0;\n\n    this.traverse_and_compute(function(n) {\n      n.json_export_index = index++;\n    }, traversal_type);\n\n    var node_array = new Array(index);\n\n    index = 0;\n\n    this.traverse_and_compute(function(n) {\n      let node_copy = _.clone(n);\n      delete node_copy.json_export_index;\n\n      if (n.parent) {\n        node_copy.parent = n.parent.json_export_index;\n      }\n\n      if (n.children) {\n        node_copy.children = _.map(n.children, function(c) {\n          return c.json_export_index;\n        });\n      }\n      node_array[index++] = node_copy;\n    }, traversal_type);\n\n    this.traverse_and_compute(function(n) {\n      delete n.json_export_index;\n    }, traversal_type);\n\n    return JSON.stringify(node_array);\n  }\n\n  /*\n   * Traverse the tree in a prescribed order, and compute a value at each node.\n   *\n   * @param {Function} callback A function to be called on each node.\n   * @param {String} traversal_type Either ``\"pre-order\"`` or ``\"post-order\"`` or ``\"in-order\"``.\n   * @param {Node} root_node start traversal here, if provided, otherwise start at root\n   * @param {Function} backtrack ; if provided, then at each node n, backtrack (n) will be called,\n                                   and if it returns TRUE, traversal will NOT continue past into this\n                                   node and its children\n   */\n  traverse_and_compute(callback, traversal_type, root_node, backtrack) {\n    traversal_type = traversal_type || \"post-order\";\n\n    function post_order(node) {\n      if (_.isUndefined(node)) {\n        return;\n      }\n\n      postOrder(node, callback, backtrack);\n\n    }\n\n    function pre_order(node) {\n      preOrder(node, callback, backtrack);\n    }\n\n    function in_order(node) {\n      inOrder(node, callback, backtrack);\n    }\n\n    if (traversal_type == \"pre-order\") {\n      traversal_type = pre_order;\n    } else {\n      if (traversal_type == \"in-order\") {\n        traversal_type = in_order;\n      } else {\n        traversal_type = post_order;\n      }\n    }\n\n    traversal_type(root_node ? root_node : this.nodes);\n\n    return this;\n\n  }\n\n  get_parsed_tags() {\n    return this.parsed_tags;\n  }\n\n  update(json) {\n    // update with new hiearchy layout\n    this.nodes = json;\n  }\n\n  // Warning : Requires DOM!\n  render(container, options) {\n    this.display = new TreeRender(this, container, options);\n    return this.display;\n  }\n\n};\n\nPhylotree.prototype.is_leafnode = node_operations.is_leafnode;\nPhylotree.prototype.mrca = mrca;\nPhylotree.prototype.has_branch_lengths = has_branch_lengths;\nPhylotree.prototype.get_branch_lengths = get_branch_lengths;\nPhylotree.prototype.branch_name = branch_name;\nPhylotree.prototype.normalize_branch_lengths = normalize;\nPhylotree.prototype.scale_branch_lengths = scale;\nPhylotree.prototype.get_newick = get_newick;\nPhylotree.prototype.resort_children = resort_children;\nPhylotree.prototype.set_branch_length = set_branch_length;\nPhylotree.prototype.max_parsimony = max_parsimony;\n\nPhylotree.prototype.leftChildRightSibling = leftChildRightSibling;\n\n_.extend(Phylotree.prototype, node_operations);\n_.extend(Phylotree.prototype, rooting);\n_.extend(Phylotree.prototype, nexus);\n\nexport function item_tagged(item) {\n  return item.tag || false;\n}\n\nexport default Phylotree;\n","import * as _ from \"underscore\";\n\n/*\n *  given a tree, this function will compute quantities required to work with \n *  all v all pairwise distances (like in COT) \n *\n *  @param   tree the tree object\n *  @returns leaf count\n *\n */\nfunction compute_pairwise_distances(tree) {\n  /*\n   *    traverse the tree and populate the following values in each node\n   *        \n   *        .cot_computed_length -> for each node (except the root), the current branch length \n   *                                (so as to not compute them each time via a callback) \n   *        .cot_leaf_index      -> post_order traversal order of a leaf (0 to number of leaves - 1)\n   *        \n   *        for each node\n   *        \n   *        .cot_path_to_leaves_below   \n   *                             -> a dictionary that maps a leaf index to the total path length from this node\n   *                                to each of the descendant leaves, EXCLUDING the length of this branch\n   *\n   *        .cot_path_to_leaves_above   \n   *                             -> a dictionary that maps a leaf index to the total path length from this node\n   *                                to each of the leaves outside the split defined by this node, EXCLUDING\n   *                                the length of this branch\n   */\n\n  var bl = tree.branch_length_accessor;\n\n  if (!bl) {\n    throw \"A non-null branch lengths accessor function is required for this operation\";\n  }\n\n  var leaf_count = 0;\n\n  tree.traverse_and_compute(function(n) {\n    n.cot_computed_length = bl(n);\n\n \n    if (n.parent && _.isUndefined(n.cot_computed_length)) {\n      throw \"Non-null branch lengths are required for this operation: missing branch length at node \" + n.data.name;\n    }\n\n    if (tree.is_leafnode(n)) {\n      n.cot_leaf_index = leaf_count++;\n      n.cot_path_to_leaves_below = {};\n      n.cot_path_to_leaves_below[n.cot_leaf_index] = 0;\n      n.cot_path_to_leaves_above = {};\n    } else {\n      n.cot_path_to_leaves_below = {};\n      n.cot_path_to_leaves_above = {};\n    }\n  });\n\n  // populate all cot_path_to_leaves_below\n  tree.traverse_and_compute(function(n) {\n    if (n.parent) {\n      _.each(n.cot_path_to_leaves_below, function(length_so_far, leaf_index) {\n        n.parent.cot_path_to_leaves_below[leaf_index] =\n          length_so_far + n.cot_computed_length;\n      });\n    }\n  });\n\n  // populate all cot_path_to_leaves_above; this is done via a 'pre-order' traversal\n  // handle root node first\n  var root_node = tree.get_root_node();\n\n  function _copy_from_siblings(a_node) {\n    for (var this_node = 0; this_node < a_node.children.length; this_node++) {\n      for (\n        var other_node = 0;\n        other_node < a_node.children.length;\n        other_node++\n      ) {\n        if (this_node != other_node) {\n          _.each(a_node.children[other_node].cot_path_to_leaves_below, function(\n            length,\n            index\n          ) {\n            if (a_node.children[this_node].cot_path_to_leaves_above) {\n              a_node.children[this_node].cot_path_to_leaves_above[index] =\n                length + a_node.children[other_node].cot_computed_length;\n            }\n          });\n        }\n      }\n    }\n  }\n\n  _copy_from_siblings(root_node);\n\n  // takes two passes\n\n  tree.traverse_and_compute(function(n) {\n    if (n.parent) {\n      // copy parent's 'above' nodes\n      _.each(n.parent.cot_path_to_leaves_above, function(\n        length_so_far,\n        leaf_index\n      ) {\n        n.cot_path_to_leaves_above[leaf_index] =\n          length_so_far + n.parent.cot_computed_length;\n      });\n\n      if (!tree.is_leafnode(n)) {\n        _copy_from_siblings(n);\n      }\n      // copy sibling's 'below' nodes\n    }\n  }, \"pre-order\");\n\n  return leaf_count;\n}\n\nexport default compute_pairwise_distances;\n","import * as _ from \"underscore\";\n\nfunction annotate_copy_number(tree) {\n  tree.traverse_and_compute(function(node) {\n    if (tree.is_leafnode(node)) {\n      node.data.copy_number = 1;\n    }\n  });\n}\n\n// internal function used by best root fitting\nfunction compute_root_to_tip_other_root(\n  tree,\n  node,\n  coming_from,\n  shared_distance,\n  distance_to_new_root\n) {\n\n  var my_bl = tree.branch_length(node);\n\n  var go_up = false;\n\n  if (!coming_from) {\n    shared_distance = node.data.root_to_tip;\n    distance_to_new_root = 0;\n    go_up = true;\n  }\n\n  if (node.children) {\n    for (var c = 0; c < node.children.length; c++) {\n      if (node.children[c] != coming_from) {\n        compute_root_to_tip_other_root(\n          tree,\n          node.children[c],\n          node,\n          shared_distance,\n          distance_to_new_root\n        );\n      } else {\n        go_up = true;\n      }\n    }\n  }\n\n  node.data.rtta = node.data.root_to_tip - shared_distance + distance_to_new_root;\n\n  if (go_up) {\n    shared_distance -= my_bl;\n    distance_to_new_root += my_bl;\n  }\n\n  if (node.parent && go_up) {\n    compute_root_to_tip_other_root(\n      tree,\n      node.parent,\n      node,\n      shared_distance,\n      distance_to_new_root\n    );\n  }\n}\n\nexport function fit_root_to_tip(tree) {\n\n  var linear_data = [],\n    max_r2 = 0,\n    best_node = 0;\n\n  annotate_copy_number(tree);\n  root_to_tip(tree);\n\n  // To return if best node is the root already\n  tree.traverse_and_compute(function(node) {\n    if (tree.is_leafnode(node) && !_.isNull(node.data.decimal_date_value)) {\n      linear_data.push([node.data.decimal_date_value, node.data.rtta, node.data.copy_number]);\n    }\n  });\n\n  let best_fit = linear_fit(linear_data);\n\n  tree.traverse_and_compute(function(node) {\n\n    if (tree.is_leafnode(node) && !_.isNull(node.data.decimal_date_value)) {\n\n      compute_root_to_tip_other_root(tree, node, null, 0, 0);\n\n      linear_data = [];\n\n      tree.traverse_and_compute(function(node) {\n        if (tree.is_leafnode(node) && !_.isNull(node.data.decimal_date_value)) {\n          linear_data.push([\n            node.data.decimal_date_value,\n            node.data.rtta,\n            node.data.copy_number\n          ]);\n        }\n      });\n\n      var fit = linear_fit(linear_data),\n        r2 = fit[\"r2\"];\n\n      if (r2 > max_r2) {\n        max_r2 = r2;\n        best_node = node;\n        best_fit = fit;\n      }\n\n    }\n  });\n\n  return { root: best_node, fit: best_fit };\n\n}\n\n// linear fit of root to tip distances\nfunction linear_fit(data) {\n\n  var ss = data.reduce(function(p, c) {\n      return c[2] + p;\n    }, 0), // sample count\n    sx = data.reduce(function(p, c) {\n      return c[2] * c[0] + p;\n    }, 0), // sum X\n    sy = data.reduce(function(p, c) {\n      return c[2] * c[1] + p;\n    }, 0), // sum Y\n    sxoss = sx / ss,\n    syoss = sy / ss;\n\n  var fitB = 0,\n    st2 = 0,\n    vary = 0;\n\n  data.forEach(function(point) {\n    var t = point[0] - sxoss;\n    st2 += point[2] * t * t;\n    fitB += point[2] * t * point[1];\n    vary += point[2] * (point[1] - syoss) * (point[1] - syoss);\n  });\n\n  fitB /= st2;\n\n  var a = (sy - sx * fitB) / ss;\n\n  var varres = 0;\n\n  data.forEach(function(point) {\n    var t = point[1] - a - fitB * point[0];\n    varres += point[2] * t * t;\n  });\n\n  return {\n    intercept: a,\n    slope: fitB,\n    r2: 1 - varres / vary,\n    \"var (intercept)\": Math.sqrt((1 + sx * sx / (ss * st2)) / ss),\n    \"var (slope)\": Math.sqrt(1 / st2)\n  };\n}\n\n/**\n *   fast and memory efficient root to tip distance calculator\n *   for each leaf node stores the current root to tip distance in \n *   the node.root_to_tip field\n *   \n *   @param tree\n *   @return tree with root_to_tip computed\n *\n */\nexport default function root_to_tip(tree) {\n\n  var bl = tree.branch_length_accessor,\n    index = 0;\n\n  tree.traverse_and_compute(n => {\n    if (n.parent) {\n      n.data._computed_length = bl(n);\n      if (!_.isNumber(n.data._computed_length)) {\n        throw \"root_to_tip cannot be run on trees with missing branch lengths\";\n      }\n    }\n    if (tree.is_leafnode(n)) {\n      n.data.leaf_index = index++;\n    }\n    if (\"r2t\" in n.data) {\n      delete n.data.r2t;\n    }\n  });\n\n  tree.traverse_and_compute(n => {\n    if (n.parent) {\n      if (!(\"r2t\" in n.parent.data)) {\n        n.parent.data.r2t = {};\n      }\n      if (tree.is_leafnode(n)) {\n        n.parent.data.r2t[n.data.leaf_index] = n.data._computed_length;\n      } else {\n        _.each(n.data.r2t, function(v, idx) {\n          n.parent.data.r2t[idx] = v + n.data._computed_length;\n        });\n        delete n.data.r2t;\n      }\n      delete n.data._computed_length;\n    }\n  });\n\n  var r2t = tree.get_root_node().data.r2t;\n\n  tree.traverse_and_compute(n => {\n    if (tree.is_leafnode(n)) {\n      n.data.root_to_tip = r2t[n.data.leaf_index] || 0;\n      delete n.data.leaf_index;\n    }\n  });\n\n  delete tree.get_root_node().data.r2t;\n\n  return tree;\n}\n","import * as _ from \"underscore\";\nimport { is_leafnode } from \"./nodes\";\n\nexport default function max_parsimony(respect_existing, attr_name) {\n\n  function populate_mp_matrix(d, attr_name) {\n\n    d.mp = [\n      [0, 0], // score for parent selected / not selected\n      [false, false]\n    ]; // selected or not\n\n    if (is_leafnode(d)) {\n\n      d.mp[1][0] = d.mp[1][1] = d.data.trait == attr_name || false;\n      d.mp[0][0] = d.mp[1][0] ? 1 : 0;\n      d.mp[0][1] = 1 - d.mp[0][0];\n\n    } else {\n\n      d.children.forEach(pop_mp_mat);\n\n      var s0 = d.children.reduce(function(p, n) {\n        return n.mp[0][0] + p;\n      }, 0);\n\n      // cumulative children score if this node is 0\n      var s1 = d.children.reduce(function(p, n) {\n        return n.mp[0][1] + p;\n      }, 0);\n\n      // cumulative children score if this node is 1\n      // parent = 0\n\n      if (d.data.trait == attr_name) {\n        // respect selected\n        d.mp[0][0] = s1 + 1;\n        d.mp[1][0] = true;\n        d.mp[0][1] = s1;\n        d.mp[1][1] = true;\n      } else {\n        if (s0 < s1 + 1) {\n          d.mp[0][0] = s0;\n          d.mp[1][0] = false;\n        } else {\n          d.mp[0][0] = s1 + 1;\n          d.mp[1][0] = true;\n        }\n\n        // parent = 1\n\n        if (s1 < s0 + 1) {\n          d.mp[0][1] = s1;\n          d.mp[1][1] = true;\n        } else {\n          d.mp[0][1] = s0 + 1;\n          d.mp[1][1] = false;\n        }\n      }\n    }\n  }\n\n  const pop_mp_mat = _.partial(populate_mp_matrix, _, attr_name);\n  pop_mp_mat(this.nodes);\n\n  this.nodes.each(d => {\n    if (d.parent) {\n      d.mp = d.mp[1][d.parent.mp ? 1 : 0];\n    } else {\n      d.mp = d.mp[1][d.mp[0][0] < d.mp[0][1] ? 0 : 1];\n    }\n    if(d.mp) d.data.trait = attr_name;\n  });\n\n  //this.display.modify_selection((d, callback) => {\n  //  if (is_leafnode(d.target)) {\n  //    return d.target[this.selection_attribute_name];\n  //  }\n  //  return d.target.mp;\n  //});\n\n}\n","import * as d3 from \"d3\";\nimport {timeParse} from 'd3-time-format';\n\nconst default_date_converter = d3.timeParse(\"%Y%m%d\");\n\nconst default_regexp = /([0-9]{4}).?([0-9]{2}).?([0-9]{2})$/g;\n\nconst default_date_getter = function(node) {\n  if (d3.layout.phylotree.is_leafnode(node)) {\n    if (\"name\" in node) {\n      var location = default_regexp.exec(node.name);\n      if (location) {\n        return location[1] + location[2] + location[3];\n      }\n    }\n  }\n  return null;\n};\n\n/*\n *  Extracts dates from nodes using a provided callback (defaults supplied),\n *  and also converts them to decimal dates; missing dates are allowed; if desired, missing dates \n *  can throw exceptions \n *  \n *  @param tree             : the tree object \n *\n *  @param date_getter      : a function that extracts date strings from nodes (e.g. by parsing the name),\n *                            default is to extract from the end of the node name, using [YYYY] optional sep [MM] optional sep [DD] format;\n *                            default is implemented in phylotree_extensions.extract_dates.date_getter ()\n *                            \n *  @param date_converter   : if provided, will be used to parse the date string; default is %Y%m%d implemented in \n *                            phylotree_extensions.extract_dates.date_converter\n *  \n *  \n *  @return tree with date-annotated nodes, i.e. each node will have\n *  \n *      n.date_value (date object, e.g. 2018-08-17); null for missing\n *      n.decimal_date_value (decimal object, e.g. 2018.72)\n *  \n */\nconst extract_dates = function(tree, date_getter, date_converter=default_date_converter) {\n\n  date_getter = date_getter || default_date_getter;\n  \n  tree.traverse_and_compute(function(n) {\n    var d_string = date_getter(n);\n    if (d_string) {\n      try {\n        n.data.date_value = date_converter(d_string);\n        var full_year = n.data.date_value.getFullYear();\n        var year_start = new Date(full_year, 0, 1),\n          year_start_p1 = new Date(full_year + 1, 0, 1);\n\n        n.data.decimal_date_value =\n          full_year +\n          (n.data.date_value - year_start) / (year_start_p1 - year_start);\n        return;\n      } catch (e) {\n        // for conversion failures\n      }\n    }\n    n.data.date_value = null;\n    n.data.decimal_date_value = null;\n  });\n\n  return tree;\n};\n\nexport default extract_dates;\n","import * as _ from \"underscore\";\n\n/*\n *special case for L^2\n *\n *For a fixed branch B, we have one parameter : where to break the branch `t` in [0, T], \n *where T is the branch length\n *\n *D   = sum (a is a leaf above B) [d(B,a) + (T-t)] ^ 2 +\n *      sum (b is a leaf below B) [d(B,b) + t] ^ 2;\n *      \n *expanding, we have \n *\n *D   = sum (a is a leaf above B) [d^2 (B,a) + 2(T-t) d(B,a) + (T-t)^2]\n *      sum (b is a leaf below B) [d^2 (B,b) + 2(t) d(B,b) + t^2]\n *      \n *    = (sum distances above)^2 + sum (distances above)*2(T-t) + (T-t)^2 * # leaves_above\n *      (sum distances below)^2 + sum (distances below)*2*t    + t^2 * # leaves_below\n *\n *      \n *Taking a derivative with respect to t we have\n *\n *dD / dt = - 2 sum (a is a leaf above B) [d(B,a) + (T-t)]\n *          + 2 sum (b is a leaf below B) [d(B,b) + t]\n *          \n *\n *second derivative is positive the function is convex, so can set to the nearest boundary if solution is outside range\n *\n *setting dD / dt to zero, we have \n *\n *- sum (distances leaves above) - T * (#leaves above) + t * (#leaves above) + sum (distances leaves below) + t * (#leaves below) = 0\n *\n *t = [sum (distances leaves above) - sum (distances leaves below) + T * (#leaves above)] / (#leaves)\n */\n\nimport { default as pairwise_distances } from \"./pairwise-distances\";\n\nexport function center_of_tree(tree, power) {\n  power = power || 2;\n\n  var leaf_count = pairwise_distances(tree);\n\n  var current_min = Number.MAX_VALUE,\n    current_split = 0,\n    current_location = null;\n\n  if (power == 2) {\n    tree.traverse_and_compute(function(n) {\n      if (n.parent) {\n        // can't consider the root\n        var sum_below = 0,\n          sum_below_squared = 0,\n          sum_above = 0,\n          sum_above_squared = 0;\n\n        var count_below = 0;\n\n        _.each(n.cot_path_to_leaves_below, function(l) {\n          sum_below += l;\n          sum_below_squared += l * l;\n          count_below++;\n        });\n\n        _.each(n.cot_path_to_leaves_above, function(l) {\n          sum_above += l;\n          sum_above_squared += l * l;\n        });\n\n        var count_above = leaf_count - count_below;\n\n        var tt =\n          (sum_above - sum_below + n.cot_computed_length * count_above) /\n          leaf_count;\n        if (tt < 0) {\n          tt = 0;\n        } else if (tt > n.cot_computed_length) {\n          tt = n.cot_computed_length;\n        }\n\n        var score =\n          sum_above_squared +\n          sum_below_squared +\n          2 * (sum_above * (n.cot_computed_length - tt) + sum_below * tt) +\n          count_below * tt * tt +\n          (n.cot_computed_length - tt) *\n            (n.cot_computed_length - tt) *\n            count_above;\n\n        if (score < current_min) {\n          current_location = n;\n          current_split = tt / n.cot_computed_length; //n.cot_computed_length-tt;//1 - tt / n.cot_computed_length;\n          current_min = score;\n        }\n\n        delete n.cot_computed_length;\n        delete n.cot_path_to_leaves_below;\n        delete n.cot_path_to_leaves_above;\n        delete n.cot_leaf_index;\n      }\n    });\n  } else {\n    // in the general case try a simple grid optimization\n    tree.traverse_and_compute(function(n) {\n      if (n.parent) {\n        // can't consider the root\n\n        var optimization_step =\n            n.cot_computed_length > 0.0 ? n.cot_computed_length * 0.05 : 0.1,\n          current_t = 0;\n\n        while (current_t < n.cot_computed_length) {\n          var score = 0.0;\n\n          _.each(n.cot_path_to_leaves_below, function(l) {\n            score += Math.pow(l + current_t, power);\n          });\n\n          _.each(n.cot_path_to_leaves_above, function(l) {\n            score += Math.pow(l + (n.cot_computed_length - current_t), power);\n          });\n\n          if (score < current_min) {\n            current_location = n;\n            current_split = current_t / n.cot_computed_length; //n.cot_computed_length-tt;//1 - tt / n.cot_computed_length;\n            current_min = score;\n          }\n          current_t += optimization_step;\n        }\n      }\n    });\n  }\n\n  return {\n    location: current_location,\n    breakpoint: current_split,\n    distance: current_min\n  };\n}\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\n\n/**\n * Implements a linear time / space version of the Cluster picker algorithm\n * \n * @param tree -- the tree object \n * @param bootstrap_thresold -- value in [0,1] that sets the stringency of bootstrap support\n * @param diameter_threshold -- value >=0 that defines the maximum allowable pairwise distance in a cluster\n * @param root_node -- if specified, traverse the tree starting here (useful for only looking at parts of the tree),\n * tree root by default\n * @param missing_bootstrap_value -- if a branch is missing bootstrap support value, use this value instead\n *                   (1.0 by default)\n *                                 \n * @return an array of clusters, where cluster = \n * {\n *    'root'   : [root node of cluster],\n *    'members' : [list of leaf. nodes],\n *    'diameter' : max distance in the cluster,\n *    'bootstrap' : bootstrap support at the root node\n * }                        \n */\nfunction cluster_picker(\n  tree,\n  bootstrap_threshold,\n  diameter_threshold,\n  root_node,\n  missing_bootstrap_value\n) {\n  root_node = root_node || tree.get_root_node();\n  missing_bootstrap_value = _.isNumber(missing_bootstrap_value)\n    ? missing_bootstrap_value\n    : 1;\n\n  // perform a bottom-up pass of the tree\n  // where each internal node will receive a floating point value\n  // that stores the longest path from the internal node to any of its descendants,\n  // the diameter of the cluster,  is then the sum of longest paths of all of its children\n  let bl = tree.branch_length;\n\n  // initialize member variables\n  tree.traverse_and_compute(function(n) {\n    if (n.parent) {\n      n._computed_length = bl(n);\n      if (!_.isNumber(n._computed_length)) {\n        throw \"cluster_picker cannot be run on trees with missing branch lengths\";\n      }\n      n.max_path_length = 0;\n    }\n  });\n\n  tree.traverse_and_compute(function(n) {\n    if (n.parent) {\n      n.parent.max_path_length = Math.max(\n        n.parent.max_path_length,\n        n.max_path_length + n._computed_length\n      );\n    }\n  });\n\n  var clusters = [];\n\n  tree.traverse_and_compute(_.noop, \"pre-order\", root_node, function(n) {\n    if (!tree.is_leafnode(n)) {\n      var bs = _.isString(n.data.bootstrap_values)\n        ? +n.data.bootstrap_values\n        : missing_bootstrap_value;\n\n      if (bs >= bootstrap_threshold) {\n        var my_diameter = _.reduce(\n          n.children,\n          function(c, n) {\n            return n.max_path_length + n._computed_length + c;\n          },\n          0\n        );\n\n        if (my_diameter <= diameter_threshold) {\n          clusters.push({ root: n, diameter: my_diameter, bootstrap: bs });\n          return true;\n        }\n      }\n    }\n\n    return false;\n  });\n\n  // clean up member variables\n  tree.traverse_and_compute(\n    function(n) {\n      if (n.parent) {\n        delete n._computed_length;\n        delete n.max_path_length;\n      }\n    },\n    \"post-order\",\n    root_node\n  );\n\n  _.each(clusters, function(cluster) {\n    cluster[\"members\"] = [];\n    tree.traverse_and_compute(\n      function(n) {\n        if (tree.is_leafnode(n)) {\n          cluster[\"members\"].push(n);\n        }\n      },\n      \"post-order\",\n      cluster[\"root\"]\n    );\n  });\n\n  return clusters;\n}\n\nexport default cluster_picker;\n","/**\n * Compute midpoint of a phylogenetic tree\n * \n * @param {Object} tree -- the phylotree.js tree object \n * @return {Object} the calculated midpoint to root on\n *  { location: root_node, breakpoint: 0 }\n *\n */\nexport function compute_midpoint(tree) {\n  if (!tree.has_branch_lengths()) {\n    throw \"Center of tree calculation cannot be performed on trees that do not have fully specified branch lengths\";\n  }\n\n  var bl = tree.branch_length;\n\n  tree.traverse_and_compute(function(node) {\n    if (node.parent) {\n      var my_longest_path_length = bl(node);\n      var my_longest_path_terminus;\n\n      if (tree.is_leafnode(node)) {\n        my_longest_path_terminus = node;\n        node.max_path = 0;\n        node.max_path_terminus = node;\n      } else {\n        my_longest_path_length += node.max_path;\n        my_longest_path_terminus = node.max_path_terminus;\n      }\n\n      if (\n        !node.parent.max_path ||\n        node.parent.max_path < my_longest_path_length\n      ) {\n        node.parent.max_path = my_longest_path_length;\n        node.parent.max_path_terminus = my_longest_path_terminus;\n      }\n    }\n  });\n\n  var root_node = tree.get_root_node();\n  var longest_path_length = 0;\n  var second_longest;\n\n  root_node.children.forEach(function(root_child) {\n    if (root_child.max_path_terminus !== root_node.max_path_terminus) {\n      var pl = root_child.max_path + bl(root_child);\n      if (pl >= longest_path_length) {\n        longest_path_length = pl;\n        second_longest = root_child.max_path_terminus;\n      }\n    }\n  });\n\n  if (root_node.max_path > longest_path_length) {\n    // not already midpoint rooted\n    longest_path_length = (longest_path_length + root_node.max_path) * 0.5;\n\n    // start traversing up from the deepest leaf to the root, until we find the\n    // half-way point\n\n    var root_on = root_node.max_path_terminus;\n\n    while (true) {\n      var current_bl = bl(root_on);\n      //console.log (current_bl, longest_path_length);\n      if (current_bl <= longest_path_length) {\n        longest_path_length -= current_bl;\n        root_on = root_on.parent;\n      } else {\n        //console.log (\"Rooting on \", root_on, longest_path_length[0], current_bl);\n\n        return {\n          location: root_on,\n          breakpoint: longest_path_length / current_bl\n        };\n\n        //console.log (\"Longest \" + root_path (tree.get_node_by_name(root_node.max_path_terminus.name)));\n        //console.log (\"Second longest \" + root_path (tree.get_node_by_name(longest_path_length[1].name)));\n      }\n    }\n  }\n  return { location: root_node, breakpoint: 0 };\n}\n","import * as _ from \"underscore\";\nimport { postOrder, preOrder, default as inOrder } from \"../traversal\";\n\n\nexport default function fitch(tree) {\n\n  // Get nodes in post-order\n  // attribute for state set\n  let attr = \"parsimony_state_set\";\n\n  // weights for probability \n  let weights = [];\n\n  // parsimony score of tree\n  let s = 0;\n\n  postOrder(tree.nodes, d => { d.visited = true });\n\n\n}\n","import * as d3 from \"d3\";\nimport * as _ from \"underscore\";\n\n/*\n *Implements a linear time / space version of the Phylopart algorithm\n *Nature Communications volume 2, Article number: 321 (2011)\n *\n *@param tree                 -- the tree object \n *\n *@param bootstrap_thresold -- value in [0,1] that sets the stringency of bootstrap support\n *\n *@param percentile threshold -- a value in 0-1, which is used to delineate how clusters\n *                               are defined; the actual criterion used is \n *        [approximate] median pairwise distance in a cluster <= %-le of tree-wide distribution \n *                               \n *@param missing_bootstrap_value -- if a branch is missing bootstrap support value, use this value instead\n *                    (1.0 by default)\n *                    \n *@param resolution -- the width of the bin for the histogram; by default is set to be the   \n *                     minimum of 0.001, branch length range / 100,\n *                     however, the maximum number of histogram bins is capped at 500 for \n *                     performance reasons\n *                                 \n *@return an array of clusters, where cluster = \n *{\n *    'root'              : [root node of cluster]\n *    'members'           : [list of leaf. nodes]\n *    'median'            : approximate median cluster distance,\n *    'bootstrap'         : bootstrap support at the root node\n *}                        \n */\n\nimport { default as pairwise_distances } from \"../metrics/pairwise-distances\";\n\nfunction phylopart(\n  tree,\n  bootstrap_threshold,\n  percentile_threshold,\n  missing_bootstrap_value,\n  resolution\n) {\n  /** TODO SLKP 20180817 : this implementation does not compute pairwise distances correctly at the moment;\n   instead it computes root-to-tip distances */\n  missing_bootstrap_value = _.isNumber(missing_bootstrap_value)\n    ? missing_bootstrap_value\n    : 1;\n\n  var leaf_count = pairwise_distances(tree);\n\n  /** first, decide on the domain of branch lengths **/\n\n  var core_node = tree.get_root_node().children[0];\n\n  var min_bl = Number.MAX_VALUE,\n    min_bl2 = Number.MAX_VALUE;\n\n  if (!(percentile_threshold > 0 && percentile_threshold < 1)) {\n    throw \"Invalid percentile threshold in perform_phylopart\";\n  }\n\n  tree.traverse_and_compute(function(n) {\n    if (tree.is_leafnode(n)) {\n      if (n.cot_computed_length < min_bl) {\n        if (min_bl < min_bl2) {\n          min_bl2 = min_bl;\n        }\n        min_bl = n.cot_computed_length;\n      } else {\n        if (n.cot_computed_length < min_bl2) {\n          min_bl2 = n.cot_computed_length;\n        }\n      }\n    }\n  });\n\n  min_bl += min_bl2;\n\n  // pairwise distances are bounded below by the sum of two shortest terminal branches\n\n  // compute the upper bound\n  var max_path_length =\n    _.reduce(\n      core_node.cot_path_to_leaves_below,\n      function(c, n) {\n        return n > c ? n : c;\n      },\n      0\n    ) +\n    _.reduce(\n      core_node.cot_path_to_leaves_above,\n      function(c, n) {\n        return n > c ? n : c;\n      },\n      0\n    ) +\n    core_node.cot_computed_length;\n\n  var domain = max_path_length - min_bl;\n\n  if (_.isUndefined(resolution)) {\n    resolution = Math.min(1e-3, domain / 100);\n  }\n\n  var number_of_bins = ((domain / resolution) >> 0) + 1;\n  if (number_of_bins > 500) {\n    number_of_bins = 500;\n    resolution = domain / number_of_bins;\n  }\n\n  var root_node = tree.get_root_node();\n\n  root_node.paths_to_leaves = new Array(leaf_count);\n\n  _.each(root_node.children, function(cn) {\n    _.each(root_node.cot_path_to_leaves_below, function(v, i) {\n      root_node.paths_to_leaves[i] = v + cn.cot_computed_length;\n    });\n  });\n\n  tree.traverse_and_compute(function(n) {\n    if (!tree.is_leafnode(n)) {\n      n.histogram = new Array(number_of_bins);\n      for (var i = 0; i < number_of_bins; i++) {\n        n.histogram[i] = 0;\n      }\n      if (n.parent) {\n        var index = 0;\n        n.paths_to_leaves = [];\n        _.each(n.cot_path_to_leaves_below, function(v, i) {\n          n.paths_to_leaves[index++] = v;\n        });\n      }\n    }\n    delete n.cot_path_to_leaves_above;\n    delete n.cot_path_to_leaves_below;\n  });\n\n  /**\n        for each internal node, produce a histogram of pairwise distances on sequences that are defined \n        by the subtree at that node\n        \n        this could be approximated (I think), by merging histograms of children\n    */\n\n  tree.traverse_and_compute(function(n) {\n    if (!tree.is_leafnode(n)) {\n      for (var n1 = 0; n1 < n.paths_to_leaves.length; n1++) {\n        for (var n2 = n1 + 1; n2 < n.paths_to_leaves.length; n2++) {\n          var sum = n.paths_to_leaves[n1] + n.paths_to_leaves[n2];\n          n.histogram[((sum - min_bl) / resolution) >> 0]++;\n        }\n      }\n      n.leaf_count = n.paths_to_leaves.length;\n\n      delete n.paths_to_leaves;\n    }\n  });\n\n  // compute the percentile distance cutoff\n\n  var total_comparisons =\n    (leaf_count - 1) * leaf_count / 2 * percentile_threshold;\n  var bin_i = 0;\n  for (\n    ;\n    bin_i < number_of_bins - 1 &&\n    total_comparisons > root_node.histogram[bin_i];\n    bin_i++\n  ) {\n    total_comparisons -= root_node.histogram[bin_i];\n  }\n\n  var median_threshold =\n    min_bl +\n    (bin_i +\n      (root_node.histogram[bin_i] - total_comparisons) /\n        root_node.histogram[bin_i]) *\n      resolution;\n\n  var clusters = [];\n\n  tree.traverse_and_compute(_.noop, \"pre-order\", null, function(n) {\n    if (!tree.is_leafnode(n)) {\n      var bs = _.isString(n.data.bootstrap_values)\n        ? +n.data.bootstrap_values\n        : missing_bootstrap_value;\n      if (bs >= bootstrap_threshold) {\n        var total_comparisons = n.leaf_count * (n.leaf_count - 1) * 0.25;\n\n        var bin_i = 0;\n        for (\n          ;\n          bin_i < number_of_bins - 1 && total_comparisons > n.histogram[bin_i];\n          bin_i++\n        ) {\n          total_comparisons -= n.histogram[bin_i];\n        }\n\n        var my_median =\n          min_bl +\n          (bin_i +\n            (n.histogram[bin_i] - total_comparisons) / n.histogram[bin_i]) *\n            resolution;\n\n        if (my_median <= median_threshold) {\n          clusters.push({ root: n, median: my_median, bootstrap: bs });\n          return true;\n        }\n      }\n    }\n    return false;\n  });\n\n  tree.traverse_and_compute(function(n) {\n    if (!tree.is_leafnode(n)) {\n      if (\"histogram\" in n) {\n        delete n.histogram;\n        delete n.leaf_count;\n      }\n    }\n  });\n\n  _.each(clusters, function(cluster) {\n    cluster[\"members\"] = [];\n    tree.traverse_and_compute(\n      function(n) {\n        if (tree.is_leafnode(n)) {\n          cluster[\"members\"].push(n);\n        }\n      },\n      \"post-order\",\n      cluster[\"root\"]\n    );\n  });\n\n  return clusters;\n}\n\nexport default phylopart;\n","import * as _ from \"underscore\";\n\n/*\n * The Sackin's index is computed as the sum of the number of ancestors for each\n * tips of the tree.\n *\n * The less balanced a tree is, the larger its Sackin's index.\n *\n */\n\nexport default function sackin(tree) {\n\n  // Get tips of tree\n  let tips = tree.get_tips();\n\n  // Count number of ancestors to root for each tree\n  let depths = _.map(tips, d => { return d.depth });\n\n  return _.reduce(depths, function(memo, num){ return memo + num; }, 0);\n\n}\n"],"names":["is_leafnode","node","_.has","graft_at","new_child","new_parent","lengths","nodes","this","descendants","parent","indexOf","parent_index","children","new_split","name","attribute","original_child_order","new_node","index","delete_a_node","length","delete_me_idx","splice","forEach","d","push","data","_.filter","n","attributes","_.each","_.indexOf","_.keys","old_key","new_key","each","respect","selection_attribute_name","newick_parser","nwk_str","bootstrap_values","delimiter","left_delimiter","right_delimiter","clade_stack","add_new_tree_level","the_parent","finish_node_definition","this_node","pop","current_node_name","current_node_attribute","current_node_annotation","generate_error","location","json","error","substring","automaton_state","quote_delimiter","name_quotes","'","\"","tree_json","space","char_index","current_char","e","test","parse_annotations","buf","str","toUpperCase","slice","data_str","_.map","split","trim","dimensions","startsWith","_.object","_.rest","format","symbols","_.reject","matrix","_.compact","_.mapObject","v","k","Array","load_annotations","tree","label","annotations","get_tips","loadTree","trees","phyloxml_parser","xml","options","xmlToJson","obj","nodeType","j","item","nodeName","nodeValue","hasChildNodes","childNodes","i","old","phyloxml","phylogeny","clade","parse_phyloxml","annotation","branch_length","taxonomy","scientific_name","format_registry","nexml","xml_string","parseString","map","nexml_tree","node_list","$","node_hash","reduce","a","b","edges","id","roots","filter","root","root_id","edge","source","parse_nexml","targets","_.pluck","_.values","_.pick","child","nexus","nexus_parser","nwk","beast","newick","parsed_newick","parse_beast_node","tokens","token","key","replace","undefined","postOrder","callback","backtrack","next","preOrder","inOrder","current","reverse","leftChildRightSibling","multiway_parent","target","def_branch_length_accessor","_node","new_length","_node_data","String","bl","parseFloat","isNaN","Math","max","fraction","new_json","d3.hierarchy","_.extendOwn","__mapped_bl","branch_length_accessor","set_branch_length","remove_me","current_node","stashed_bl","_.noop","apportioned_bl","remove_idx","_mapped_bl","t","concat","update","traverse_and_compute","c","_.isUndefined","display","container","render","attr_name","store_name","my_value","selection","x_coord","y","y_coord","x","radial_mapper","r","radial_center","sin","cos","cartesian_to_polar","radius","radial_root_offset","scales","size","angle","PI","radial","draw_arc","points","start","end","arc_segment_placer","where","draw_line","d3\n  .line","curve","d3.curveStepBefore","line_segment_placer","item_tagged","tag","item_selected","css_classes","tree-container","tree-scale-bar","internal-node","tagged-node","selected-node","collapsed-node","root-node","branch","selected-branch","tagged-branch","tree-selection-brush","branch-tracer","node_text","node_span","attr","arguments","phylotree","predefined_selecters","all","none","all-leaf-nodes","all-internal-nodes","relative_node_span","text_align","radius_pad_for_bubbles","right_most_leaf","screen_x","layout_listener_handler","sync_edge_labels","selection_callback","node_visible","hidden","notshown","node_notshown","has_hidden_nodes","is_node_collapsed","collapsed","node_css_selectors","p","def_node_label","show_internal_name","transitions","d3.select","is_leaf","labels","selectAll","tracers","enter","append","classed","merge","on","handle_node_click","shown_font_size","text","_node_label","style","ensure_size_is_in_px","d3_phylotree_svg_rotate","text_angle","d3_phylotree_svg_translate","align_tips","shift_tip","node_bubble_size","remove","shift","circles","node_circle_size","min","node_styler","i_names","internal_names","class_var","respect_existing","clear_internal_nodes","self","modify_selection","clade_css_selectors","collapsed_clades","svg","node_id","spline","spline_f","d3\n      .line","d3.curveBasis","coord","init_0","init_1","screen_y","exit","collapsed_clade","insert","edge_visible","edge_css_selectors","transition","reclass_edge","new_branch_path","draw_branch","datum","existing_path","haz_title","empty","edge_styler","links","count_handler","counts","count_update","edge_placer","trigger_refresh","event","CustomEvent","detail","document","dispatchEvent","d3_phylotree_event_listener","refresh","unhide","placenodes","tr","sizes","pad_radius","pad_width","vertical_offset","pad_height","scale","layout_handler","addEventListener","menu_object","d3\n    .select","select","d3\n      .select","_.some","Boolean","menu_items","toggle_collapse","select_all_descendants","path_to_root","reroot","update_has_hidden_nodes","has_user_elements","show_divider_options","constant","_.partial","tree_container","coordinates","d3.mouse","condition","some","node_selecter","place","skip_refresh","mode","_.contains","select_me","do_refresh","type","new_value","events.trigger_refresh","events.count_update","get_selection","terminal","internal","sel","TreeRender","[object Object]","separation","_previous","fixed_width","font_size","scale_bar_font_size","offsets","draw_scale_bar","count_listener_handler","label_width","rescale_node_span","default_options","layout","logger","console","branches","scaling","bootstrap","color-fill","internal-names","selectable","restricted-selectable","collapsible","left-right-spacing","top-bottom-spacing","left-offset","right-offset","show-scale","draw-size-bubbles","binary-selectable","is-radial","attribute-list","max-radius","annular-limit","compression","align-tips","maximum-per-node-spacing","minimum-per-node-spacing","maximum-per-level-spacing","minimum-per-level-spacing","brush","hide","label-nodes-with-name","zoom","show-menu","show-labels","value","_.defaults","width","height","initialize_svg","_label_width","render_nodes.is_node_collapsed","phylo_attr","svg_element","d3\n        .select","set_size","do_hierarchy","enclosure","scale_bar","call","update_collapsed_clades","drawn_links","render_edges.edge_css_selectors","render_edges.edge_visible","draw_edge","drawn_nodes","render_nodes.node_css_selectors","render_nodes.node_visible","reclass_node","should_shift","draw_node","resize_svg","brush_object","d3\n        .brush","extent","d3.event","selected_links","d3.zoom","scaleExtent","translate","transform","d3\n          .select","a_node","last_node","last_span","is_under_collapsed_parent","save_x","_node_span","_extents","save_span","render_nodes.node_notshown","undef_BL","do_scaling","max_depth","depth","_handle_single_node_layout","process_internal_node","map_me","count_undefined","half_way","displayed_children","managed_to_display","child_id","tree_layout","bind","at_least_one_dimension_fixed","available_width","d3.max","_","last_child_angle","last_circ_position","last_child_radius","min_radius","effective_span","compute_distance","r1","r2","a1","a2","annular_shift","sqrt","max_r","my_circ_position","do_lr","required_spacing","radial_dist","local_mr","dd","st","scaler","z","last_point","pow","last_x","domain_limit","range_limit","ceil","log","stretch","d3\n          .scaleLinear","domain","range","scaleTickFormatter","d3.format","d3.axisTop","tickFormat","tickValues","round","my_ticks","ticks","skip_render","_font_size","node_width","abs","attr2","opt","arg","css","run_update","do_update","d3_phylotree_trigger_layout","node_dropdown_menu","prototype","clades","render_nodes","render_edges","events","menus","Phylotree","newick_string","parsed_tags","partitions","_.isString","parser_registry","_.isFunction","contentType","_parsed_tags","Object","keys","traversal_type","json_export_index","node_array","node_copy","_.clone","JSON","stringify","root_node","compute_pairwise_distances","leaf_count","_copy_from_siblings","other_node","cot_path_to_leaves_below","cot_path_to_leaves_above","cot_computed_length","cot_leaf_index","length_so_far","leaf_index","get_root_node","linear_fit","ss","sx","sy","sxoss","syoss","fitB","st2","vary","point","varres","intercept","slope","var (intercept)","var (slope)","root_to_tip","_computed_length","_.isNumber","r2t","idx","node_operations.is_leafnode","mrca","mrca_nodes","from","mrca_node","_.union","_.intersection","has_branch_lengths","_.every","get_branch_lengths","branch_name","node_label","normalize_branch_lengths","branch_lengths","max_bl","_.max","min_bl","_.min","len","scale_branch_lengths","scale_by","get_newick","annotator","element_array","node_display","join","resort_children","comparator","start_node","sum","sort","update_layout","max_parsimony","pop_mp_mat","mp","trait","s0","s1","node_operations","rooting","default_date_converter","d3.timeParse","default_regexp","default_date_getter","d3.layout","exec","power","pairwise_distances","current_min","Number","MAX_VALUE","current_split","current_location","sum_below","sum_below_squared","sum_above","sum_above_squared","count_below","l","count_above","tt","score","optimization_step","current_t","breakpoint","distance","bootstrap_threshold","diameter_threshold","missing_bootstrap_value","max_path_length","clusters","bs","my_diameter","_.reduce","diameter","cluster","my_longest_path_terminus","my_longest_path_length","max_path","max_path_terminus","longest_path_length","root_child","pl","root_on","current_bl","date_getter","date_converter","d_string","date_value","full_year","getFullYear","year_start","Date","year_start_p1","decimal_date_value","linear_data","max_r2","best_node","copy_number","annotate_copy_number","_.isNull","rtta","best_fit","compute_root_to_tip_other_root","coming_from","shared_distance","distance_to_new_root","my_bl","go_up","fit","visited","percentile_threshold","resolution","core_node","min_bl2","number_of_bins","paths_to_leaves","cn","histogram","n1","n2","total_comparisons","bin_i","median_threshold","my_median","median","tips","depths","memo","num"],"mappings":"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"}